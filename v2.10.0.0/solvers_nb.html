

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alternative Linear Solvers (Scipy and Petsc) &mdash; Tutorial for version 2.11-git</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/nbsphinx-code-cells.css?v=2aa19091" />

  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Examples of grid construction" href="othergrids_nb.html" />
    <link rel="prev" title="More General Boundary Conditions" href="boundary_nb.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html">
            
              <img src="_static/dune-python-logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
     <span class="caption-text">
     <li><u><a href="genindex.html" style="color:white">Keyword list</a></u></li>
     <li><u><a href="changelog290.html" style="color:white">Most recent changes</a></u></li>
     </span>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">An Overview of this Document</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">From PyPi</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#hints-for-windows">Hints for Windows</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="installation.html#from-source">From Source</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#building-the-required-dune-modules">Building the Required Dune Modules</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="installation.html#troubleshooting">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="dune-fempy_nb.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="dune-fempy_nb.html#A-Laplace-problem">A Laplace problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="dune-fempy_nb.html#Laplace-equation-with-Dirichlet-boundary-conditions">Laplace equation with Dirichlet boundary conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="dune-fempy_nb.html#A-non-linear-elliptic-problem">A non-linear elliptic problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="dune-fempy_nb.html#Using-Constant-parameters-and-grid-functions-in-PDEs">Using <code class="docutils literal notranslate"><span class="pre">Constant</span></code> parameters and grid functions in PDEs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="concepts_nb.html">General Concepts (with a time dependent problem)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="concepts_nb.html#Setting-up-the-Grid">Setting up the Grid</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts_nb.html#Grid-Functions">Grid Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts_nb.html#Discrete-Spaces">Discrete Spaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts_nb.html#Discrete-Functions">Discrete Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts_nb.html#Operators-and-Schemes">Operators and Schemes</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts_nb.html#A-Nonlinear-Time-Dependent-Problem">A Nonlinear Time Dependent Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts_nb.html#Listing-Available-Dune-Components">Listing Available Dune Components</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Next Steps</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="boundary_nb.html">More General Boundary Conditions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="boundary_nb.html#Dirichlet-boundary-conditions">Dirichlet boundary conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="boundary_nb.html#Accessing-the-Dirichlet-degrees-of-freedom">Accessing the Dirichlet degrees of freedom</a></li>
<li class="toctree-l2"><a class="reference internal" href="boundary_nb.html#Neumann-and-Robin-boundary-conditions">Neumann and Robin boundary conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="boundary_nb.html#Using-boundary-ids-(and-some-more-complex-examples)">Using boundary ids (and some more complex examples)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="boundary_nb.html#Cartesian-boundary-ids">Cartesian boundary ids</a></li>
<li class="toctree-l3"><a class="reference internal" href="boundary_nb.html#Mixing-different-types-of-boundary-conditions">Mixing different types of boundary conditions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Alternative Linear Solvers (Scipy and Petsc)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Using-Scipy">Using Scipy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Handling-Dirichlet-boundary-conditions">Handling Dirichlet boundary conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Using-PETSc-and-Petsc4Py">Using PETSc and Petsc4Py</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Accessing-and-reusing-values-of-parameters">Accessing and reusing values of parameters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Parameter-hints">Parameter hints</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Available-solvers-and-parameters">Available solvers and parameters</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="othergrids_nb.html">Examples of grid construction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="othergrids_nb.html#Example-using-the-Dune-Grid-Format-(DGF)">Example using the Dune Grid Format (DGF)</a></li>
<li class="toctree-l2"><a class="reference internal" href="othergrids_nb.html#3D-example-(using-PyGmsh)">3D example (using PyGmsh)</a></li>
<li class="toctree-l2"><a class="reference internal" href="othergrids_nb.html#Converting-gmsh-to-DGF">Converting gmsh to DGF</a><ul>
<li class="toctree-l3"><a class="reference internal" href="othergrids_nb.html#Attaching-boundary-ids-to-a-grid-constructed-with-gmsh-using-DGF">Attaching boundary ids to a grid constructed with gmsh using DGF</a></li>
<li class="toctree-l3"><a class="reference internal" href="othergrids_nb.html#Visualizing-Boundary-Ids">Visualizing Boundary Ids</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="othergrids_nb.html#Using-meshio-to-read-a-gmsh-file">Using <code class="docutils literal notranslate"><span class="pre">meshio</span></code> to read a gmsh file</a></li>
<li class="toctree-l2"><a class="reference internal" href="othergrids_nb.html#1D-example">1D example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="parallelization_nb.html">Parallelization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="parallelization_nb.html#OpenMP">OpenMP</a></li>
<li class="toctree-l2"><a class="reference internal" href="parallelization_nb.html#MPI">MPI</a><ul>
<li class="toctree-l3"><a class="reference internal" href="parallelization_nb.html#Load-balancing">Load balancing</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="backuprestore_nb.html">Backup and restore (pickling)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="backuprestore_nb.html#Pickling">Pickling</a></li>
<li class="toctree-l2"><a class="reference internal" href="backuprestore_nb.html#A-Chekpointer-class">A Chekpointer class</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="corepy.html">Using the Full Grid Interface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="dune-corepy_nb.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="dune-corepy_nb.html#Dense-Vectors-and-the-Geometry-Classes">Dense Vectors and the Geometry Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="dune-corepy_nb.html#Grid-Construction-and-Basic-Interface">Grid Construction and Basic Interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="dune-corepy_nb.html#Structured-grids">Structured grids</a></li>
<li class="toctree-l3"><a class="reference internal" href="dune-corepy_nb.html#Unstructured-grids">Unstructured grids</a></li>
<li class="toctree-l3"><a class="reference internal" href="dune-corepy_nb.html#Local-grid-adaptivity">Local grid adaptivity</a><ul>
<li class="toctree-l4"><a class="reference internal" href="dune-corepy_nb.html#Basic-information-and-iterators">Basic information and iterators</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="dune-corepy_nb.html#Using-grid-functions">Using grid functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="dune-corepy_nb.html#Importing-user-defined-C++-code">Importing user defined C++ code</a></li>
<li class="toctree-l2"><a class="reference internal" href="dune-corepy_nb.html#Attaching-Data-to-the-Grid">Attaching Data to the Grid</a></li>
<li class="toctree-l2"><a class="reference internal" href="dune-corepy_nb.html#Output-of-Grid-and-Visualization-of-Data">Output of Grid and Visualization of Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="dune-corepy_nb.html#Matplotlib">Matplotlib</a></li>
<li class="toctree-l3"><a class="reference internal" href="dune-corepy_nb.html#Paraview-(vtu/vtk-files)">Paraview (vtu/vtk files)</a></li>
<li class="toctree-l3"><a class="reference internal" href="dune-corepy_nb.html#Mayavi">Mayavi</a></li>
<li class="toctree-l3"><a class="reference internal" href="dune-corepy_nb.html#Low-level-output">Low level output</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Further Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="discontinuousgalerkin_nb.html">Discontinuous Galerkin Methods</a><ul>
<li class="toctree-l2"><a class="reference internal" href="discontinuousgalerkin_nb.html#Advection-Diffusion:-Discontinuous-Galerkin-Method-with-Upwinding">Advection-Diffusion: Discontinuous Galerkin Method with Upwinding</a></li>
<li class="toctree-l2"><a class="reference internal" href="discontinuousgalerkin_nb.html#A-linear-transport-problem">A linear transport problem</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="elasticity_nb.html">Linear Elasticity: a deformed beam</a></li>
<li class="toctree-l1"><a class="reference internal" href="spiral_nb.html">Time Dependent Reaction Diffuison: spiral wave</a></li>
<li class="toctree-l1"><a class="reference internal" href="wave_nb.html">Wave Equation: double slit domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="stokes.html">Saddle point solver for the stationary Stokes problem</a><ul>
<li class="toctree-l2"><a class="reference internal" href="monolithicStokes_nb.html">Monolithic solver (Lagrange and DG formulation)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="monolithicStokes_nb.html#Taylor-Hood-formulation">Taylor-Hood formulation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="monolithicStokes_nb.html#Bercovier-Engelmann-Testcase">Bercovier-Engelmann Testcase</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="monolithicStokes_nb.html#DG-formulation">DG formulation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="monolithicStokes_nb.html#id3">Bercovier-Engelmann Testcase</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="monolithicStokes_nb.html#Convergence-rate-check">Convergence rate check</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="fieldsplitStokes_nb.html">Stokes problem with fieldsplit preconditioner (PETSc)</a></li>
<li class="toctree-l2"><a class="reference internal" href="uzawa-scipy_nb.html">(Quasi) Stokes equations (Scipy based Uzawa scheme)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="evalues_laplace_nb.html">Eigenvalue problems</a><ul>
<li class="toctree-l2"><a class="reference internal" href="evalues_laplace_nb.html#Eigenvalues-of-the-Neumann-Laplacian">Eigenvalues of the Neumann Laplacian</a></li>
<li class="toctree-l2"><a class="reference internal" href="evalues_laplace_nb.html#Dirichlet-Eigenvalue-problem">Dirichlet Eigenvalue problem</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="crystal_nb.html">Adaptive phase field: crystal growth model</a></li>
<li class="toctree-l1"><a class="reference internal" href="mcf_nb.html">Moving surface grid: flow under mean curvature</a></li>
<li class="toctree-l1"><a class="reference internal" href="laplace-dwr_nb.html">Dual Weighted Reisdual Estimate</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Further Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="gridviews.html">Adaptivity and Moving Domains: extended grid views</a><ul>
<li class="toctree-l2"><a class="reference internal" href="gridviews.html#overview-and-some-basic-grid-views-level-and-filtered">Overview and some basic grid views (level and filtered)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="levelgridview_nb.html">LevelGridView examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="filteredgridview_nb.html">FilteredGridView examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="gridviews.html#dynamic-local-grid-refinement-and-coarsening">Dynamic Local Grid Refinement and Coarsening</a><ul>
<li class="toctree-l3"><a class="reference internal" href="laplace-adaptive_nb.html">Re-entrant Corner Problem</a></li>
<li class="toctree-l3"><a class="reference internal" href="crystal_nb.html">Adaptive phase field: crystal growth model</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="gridviews.html#evolving-domains">Evolving Domains</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mcf_nb.html">Moving surface grid: flow under mean curvature</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cpp.html">Using C++ Code Snippets</a><ul>
<li class="toctree-l2"><a class="reference internal" href="cppfunctions_nb.html">C++ Based Grid Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="lineplot_nb.html">Sampling the Solution over a Line</a></li>
<li class="toctree-l2"><a class="reference internal" href="mcf-algorithm_nb.html">Mean Curvature Flow (revisited)</a></li>
<li class="toctree-l2"><a class="reference internal" href="laplace-dwr-algorithm_nb.html">Dual Weighted Reisdual Estimate (revisited)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="scheme_api.html">API for schemes and operators</a><ul>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#abstract-concepts">Abstract concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#operator-without-dbc">Operator without DBC:</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#operator-with-dbc">Operator with DBC:</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#scheme-without-dbc">Scheme without DBC:</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#scheme-with-dbc">Scheme with DBC:</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#additional">Additional</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#unclear">Unclear</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Extension Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="femdg.html">Discontinuous Galerkin Methods: the DUNE-FEM-DG Module</a><ul>
<li class="toctree-l2"><a class="reference internal" href="euler_nb.html">Euler System of Gas Dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="chemical_nb.html">An Advection-Diffusion-Reaction System: Chemical Reaction Problem</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="vemdemo_descr.html">Virtual Element Methods: the DUNE-VEM module</a><ul>
<li class="toctree-l2"><a class="reference internal" href="vemdemo_nb.html">Elliptic Problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="vemdemo_nb.html#Nonlinear-Elliptic-Problem">Nonlinear Elliptic Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="vemdemo_nb.html#Linear-Elasticity">Linear Elasticity</a></li>
<li class="toctree-l2"><a class="reference internal" href="vemdemo_nb.html#Fourth-order-problem">Fourth order problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="chimpl_nb.html">Cahn-Hilliard</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Projects</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="twophaseflow_descr.html">HP adaptive DG scheme for twophase flow problem</a><ul>
<li class="toctree-l2"><a class="reference internal" href="twophaseflow_nb.html">Problem Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="twophaseflow_nb.html#Defining-the-model">Defining the model</a></li>
<li class="toctree-l2"><a class="reference internal" href="twophaseflow_nb.html#Time-discretization">Time discretization</a></li>
<li class="toctree-l2"><a class="reference internal" href="twophaseflow_nb.html#Stabilization-(Limiter)">Stabilization (Limiter)</a></li>
<li class="toctree-l2"><a class="reference internal" href="twophaseflow_nb.html#Iterative-schemes-(iterative-or-impes-iterative)">Iterative schemes (iterative or impes-iterative)</a></li>
<li class="toctree-l2"><a class="reference internal" href="twophaseflow_nb.html#HP-Adpativity">HP Adpativity</a></li>
<li class="toctree-l2"><a class="reference internal" href="twophaseflow_nb.html#Marker-for-grid-adaptivity-(h)">Marker for grid adaptivity (h)</a></li>
<li class="toctree-l2"><a class="reference internal" href="twophaseflow_nb.html#Marker-for-space-adaptivity-(p)">Marker for space adaptivity (p)</a></li>
<li class="toctree-l2"><a class="reference internal" href="twophaseflow_nb.html#Main-program">Main program</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="mmesh_descr.html">Mixed-dimensional PDEs: the Dune-MMesh module</a><ul>
<li class="toctree-l2"><a class="reference internal" href="mmesh_nb.html">Dune-MMesh: Solving a Mixed-dimensional PDE</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Information and Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="citing.html">Citing this project</a></li>
<li class="toctree-l1"><a class="reference internal" href="developers.html">Information for C++ Developers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="developers.html#remove-and-rebuild-existing-modules">Remove and rebuild existing modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="developers.html#using-a-debugger">Using a debugger</a></li>
<li class="toctree-l2"><a class="reference internal" href="developers.html#list-of-build-specific-environment-variables">List of build specific environment variables</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contributions.html">How to showcase your own project</a></li>
<li class="toctree-l1"><a class="reference internal" href="additional.html">Notebooks and Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="additional.html#mesh-files-used-in-the-examples">Mesh Files used in the Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="changelog290.html">Since 2.9 release</a><ul>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#deprecation-of-dune-ufl-expression2gf">Deprecation of <code class="docutils literal notranslate"><span class="pre">dune.ufl.expression2GF</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#deprecation-of-dune-fem-function-integrate">Deprecation of <code class="docutils literal notranslate"><span class="pre">dune.fem.function.integrate</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#deprecation-of-dune-fem-function-uflfunction-and-dune-fem-function-cppfunction">Deprecation of <code class="docutils literal notranslate"><span class="pre">dune.fem.function.uflFunction</span></code> and <code class="docutils literal notranslate"><span class="pre">dune.fem.function.cppFunction</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#id1">Deprecation of <code class="docutils literal notranslate"><span class="pre">dune.ufl.expression2GF</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#deprecation-of-dune-fem-operator-linear">Deprecation of <code class="docutils literal notranslate"><span class="pre">dune.fem.operator.linear</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#deprecation-of-dune-fem-space-combinedspace">Deprecation of <code class="docutils literal notranslate"><span class="pre">dune.fem.space.combinedSpace</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#add-dirichletindices-method-to-operators-and-schemes">Add <code class="docutils literal notranslate"><span class="pre">DirichletIndices</span></code> method to operators and schemes</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#extension-of-the-jacobian-method-on-schemes-and-operators">Extension of the <code class="docutils literal notranslate"><span class="pre">jacobian</span></code> method on schemes and operators</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#set-non-default-quadratures-in-quadrature-rules">Set non default quadratures in quadrature rules</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#assembly-function">Assembly function</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#improved-pickling-support">Improved Pickling support</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#paraview-reader">Paraview Reader</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#sampler-along-boundary">Sampler along Boundary</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#point-sampler-returning-entity-local-coordinate-for-given-global-coordinate">Point sampler returning (entity,local coordinate) for given global coordinate</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#improved-dirichlet-boundary-indexing-in-ufl-forms">Improved Dirichlet Boundary Indexing in UFL Forms</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#eisenstatwalker-in-newton-method">Eisenstatwalker in Newton method</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#storage-setup-in-scheme">Storage setup in scheme</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#methods-on-space-to-return-local-mapper-and-for-evaluating-basis-functions">Methods on space to return local mapper and for evaluating basis functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#logging-of-parameter-values">Logging of parameter values</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="inforesources.html">Keyword index</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional pages</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="gmsh2dgf_nb.html">Converting gmsh to DGF</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurmbatchscript.html">Slurm batch script</a></li>
<li class="toctree-l1"><a class="reference internal" href="scheme_api.html">API for schemes and operators</a><ul>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#abstract-concepts">Abstract concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#operator-without-dbc">Operator without DBC:</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#operator-with-dbc">Operator with DBC:</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#scheme-without-dbc">Scheme without DBC:</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#scheme-with-dbc">Scheme with DBC:</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#additional">Additional</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#unclear">Unclear</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="todo.html">List of things that need doing…</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">DUNE-FEM Tutorial</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="nextsteps.html">Next steps</a></li>
      <li class="breadcrumb-item active">Alternative Linear Solvers (Scipy and Petsc)</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul><div class="rst-breadcrumbs-buttons" role="navigation" aria-label="Sequential page navigation">
        <a href="boundary_nb.html" class="btn btn-neutral float-left" title="More General Boundary Conditions" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="othergrids_nb.html" class="btn btn-neutral float-right" title="Examples of grid construction" accesskey="n">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="admonition note">
<p class="admonition-title">Note</p>
This document is part of the dune-fem tutorial
<a href="https://doi.org/10.5281/zenodo.3706994"><img src="https://zenodo.org/badge/DOI/10.5281/zenodo.3706994.svg" alt="DOI"></a><div class="line-block">
<div class="line">Download <em>solvers</em> as <a class="reference download internal" download="" href="_downloads/c87c744d47d993b3149040ed4bd059d6/solvers_nb.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Jupyter</span> <span class="pre">notebook</span> <span class="pre">(_nb.ipynb)</span></code></a> or as <a class="reference download internal" download="" href="_downloads/f01767f691faeef7cb79fe37604b8b26/solvers.py"><code class="xref download docutils literal notranslate"><span class="pre">Python</span> <span class="pre">script</span> <span class="pre">(.py)</span></code></a></div>
</div>
</div>
<section id="Alternative-Linear-Solvers-(Scipy-and-Petsc)">
<h1>Alternative Linear Solvers (Scipy and Petsc)<a class="headerlink" href="#Alternative-Linear-Solvers-(Scipy-and-Petsc)" title="Link to this heading"></a></h1>
<p>Here we look at different ways of solving PDEs using external packages and python functionality. Different linear algebra backends can be accessed by changing setting the <code class="docutils literal notranslate"><span class="pre">storage</span></code> parameter during construction of the discrete space. All discrete functions and operators/schemes based on this space will then use this backend. Available backends are <code class="docutils literal notranslate"><span class="pre">numpy,istl,petsc</span></code>. The default is <code class="docutils literal notranslate"><span class="pre">numpy</span></code> which uses simple data structures and linear solvers implemented in the <code class="docutils literal notranslate"><span class="pre">dune-fem</span></code> package. The
simplicity of the data structure makes it possible to use the buffer protocol to seamlessly move between C++ and Numpy/Scipy data structures on the python side. A degrees of freedom vector (dof vector) can be retrieved from a discrete function over the <code class="docutils literal notranslate"><span class="pre">numpy</span></code> space by using the <code class="docutils literal notranslate"><span class="pre">as_numpy</span></code> method. Similar methods are available for the other storages, i.e., <code class="docutils literal notranslate"><span class="pre">as_istl,as_petsc</span></code>. The same methods are also available to retrieve the underlying matrix structures of linear operators.</p>
<p>We will mostly revisit the nonlinear time dependent problem studied at the end of the <a class="reference internal" href="concepts_nb.html"><span class="doc">concepts section</span></a> which after discretizing in time had the variational formulation <span class="math">\begin{equation}
\begin{split}
\int_{\Omega} \frac{u^{n+1}-u^n}{\Delta t} \varphi
+ \frac{1}{2}K(\nabla u^{n+1}) \nabla u^{n+1} \cdot \nabla \varphi \
+ \frac{1}{2}K(\nabla u^n) \nabla u^n \cdot \nabla \varphi v\ dx \\
- \int_{\Omega} \frac{1}{2}(f(x,t^n)+f(x,t^n+\Delta t) \varphi\ dx
- \int_{\partial \Omega} \frac{1}{2}(g(x,t^n)+g(x,t^n+\Delta t)) v\ ds
= 0.
\end{split}
\end{equation}</span>\end{equation} on a domain <span class="math notranslate nohighlight">\(\Omega=[0,1]^2\)</span>. We choose <span class="math notranslate nohighlight">\(f,g\)</span> so that the exact solution is given by <span class="math">\begin{align*}
u(x,t) = e^{-2t}\left(\frac{1}{2}(x^2 + y^2) - \frac{1}{3}(x^3 - y^3)\right) + 1
\end{align*}</span> The following code was described in the <a class="reference internal" href="concepts_nb.html"><span class="doc">concepts section</span></a></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="o">,</span><span class="w"> </span><span class="nn">sys</span><span class="o">,</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dune.grid</span><span class="w"> </span><span class="kn">import</span> <span class="n">structuredGrid</span> <span class="k">as</span> <span class="n">leafGridView</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dune.fem.space</span><span class="w"> </span><span class="kn">import</span> <span class="n">lagrange</span> <span class="k">as</span> <span class="n">solutionSpace</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dune.fem.scheme</span><span class="w"> </span><span class="kn">import</span> <span class="n">galerkin</span> <span class="k">as</span> <span class="n">solutionScheme</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dune.fem.function</span><span class="w"> </span><span class="kn">import</span> <span class="n">gridFunction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dune.fem</span><span class="w"> </span><span class="kn">import</span> <span class="n">integrate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dune.ufl</span><span class="w"> </span><span class="kn">import</span> <span class="n">Constant</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufl</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestFunction</span><span class="p">,</span> <span class="n">TrialFunction</span><span class="p">,</span> <span class="n">SpatialCoordinate</span><span class="p">,</span> <span class="n">FacetNormal</span><span class="p">,</span> \
                <span class="n">dx</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">div</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">dot</span><span class="p">,</span> <span class="n">inner</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span>\
                <span class="n">conditional</span>

<span class="n">gridView</span> <span class="o">=</span> <span class="n">leafGridView</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="n">space</span> <span class="o">=</span> <span class="n">solutionSpace</span><span class="p">(</span><span class="n">gridView</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">SpatialCoordinate</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>
<span class="n">initial</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">exact</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">initial</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">u_h</span>   <span class="o">=</span> <span class="n">space</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;u_h&#39;</span><span class="p">)</span>
<span class="n">u_h_n</span> <span class="o">=</span> <span class="n">u_h</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;previous&quot;</span><span class="p">)</span>

<span class="n">u</span> <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;dt&quot;</span><span class="p">)</span>    <span class="c1"># time step</span>
<span class="n">t</span>  <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>     <span class="c1"># current time</span>

<span class="n">abs_du</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">)))</span>
<span class="n">K</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">abs_du</span><span class="p">(</span><span class="n">u</span><span class="p">)))</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">(</span> <span class="n">dot</span><span class="p">((</span><span class="n">u</span> <span class="o">-</span> <span class="n">u_h_n</span><span class="p">)</span><span class="o">/</span><span class="n">dt</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> \
    <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> \
    <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">(</span><span class="n">u_h_n</span><span class="p">)</span><span class="o">*</span><span class="n">grad</span><span class="p">(</span><span class="n">u_h_n</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>

<span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">initial</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">div</span><span class="p">(</span> <span class="n">K</span><span class="p">(</span><span class="n">exact</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="o">*</span><span class="n">grad</span><span class="p">(</span><span class="n">exact</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">K</span><span class="p">(</span><span class="n">exact</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="o">*</span><span class="n">grad</span><span class="p">(</span><span class="n">exact</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">FacetNormal</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">+</span><span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="n">dt</span><span class="p">))</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">dx</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">+</span><span class="n">g</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="n">dt</span><span class="p">),</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">ds</span>
</pre></div>
</div>
</div>
<p>When creating a scheme, it is possible to set the linear solver as well as parameters for the internal Newton solver and the linear solver and preconditioning. See a list of available solvers and preconditioning methods at the end of this section.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scheme</span> <span class="o">=</span> <span class="n">solutionScheme</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;cg&#39;</span><span class="p">)</span>

<span class="n">endTime</span>    <span class="o">=</span> <span class="mf">0.25</span>
<span class="n">exact_end</span>  <span class="o">=</span> <span class="n">exact</span><span class="p">(</span><span class="n">endTime</span><span class="p">)</span>
<span class="n">l2error</span> <span class="o">=</span> <span class="n">gridFunction</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;l2error&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="n">dot</span><span class="p">(</span><span class="n">u_h</span> <span class="o">-</span> <span class="n">exact_end</span><span class="p">,</span> <span class="n">u_h</span> <span class="o">-</span> <span class="n">exact_end</span><span class="p">))</span>
<span class="n">h1error</span> <span class="o">=</span> <span class="n">gridFunction</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;h1error&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u_h</span> <span class="o">-</span> <span class="n">exact_end</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">u_h</span> <span class="o">-</span> <span class="n">exact_end</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<p>We define a function to evolve the solution from time 0 to the end time. The first argument is a class with a <code class="docutils literal notranslate"><span class="pre">solve</span></code> method that moves the solution from one time level to the next - i.e., solves the non-linear problem for <span class="math notranslate nohighlight">\(u^{n+1}\)</span> given <span class="math notranslate nohighlight">\(u^n\)</span>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">u_h</span><span class="p">,</span> <span class="n">u_h_n</span><span class="p">,</span> <span class="n">endTime</span><span class="p">):</span>
    <span class="n">time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">endTime</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">):</span>
        <span class="n">t</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">time</span>
        <span class="n">u_h_n</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">u_h</span><span class="p">)</span>
        <span class="n">scheme</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">u_h</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">+=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dt</span>
</pre></div>
</div>
</div>
<p>We can simply use the <code class="docutils literal notranslate"><span class="pre">galerkinScheme</span></code> instance <code class="docutils literal notranslate"><span class="pre">scheme</span></code> in this function to produce the solution at the final time. We combine this with a loop to compute the error over two grids and estimate the convergence rate:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dt</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.005</span>

<span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
<span class="n">loops</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">for</span> <span class="n">eocLoop</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">loops</span><span class="p">):</span>
    <span class="n">u_h</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span>
    <span class="n">evolve</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">u_h</span><span class="p">,</span> <span class="n">u_h_n</span><span class="p">,</span> <span class="n">endTime</span><span class="p">)</span>
    <span class="n">errors_old</span> <span class="o">=</span> <span class="n">errors</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">sqrt</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">integrate</span><span class="p">([</span><span class="n">l2error</span><span class="p">,</span><span class="n">h1error</span><span class="p">])]</span>
    <span class="k">if</span> <span class="n">eocLoop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">eocs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eocs</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">round</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">e</span><span class="o">/</span><span class="n">e_old</span><span class="p">)</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span> \
                 <span class="k">for</span> <span class="n">e</span><span class="p">,</span><span class="n">e_old</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span><span class="n">errors_old</span><span class="p">)</span> <span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Forchheimer: step:&#39;</span><span class="p">,</span> <span class="n">eocLoop</span><span class="p">,</span> <span class="s1">&#39;, size:&#39;</span><span class="p">,</span> <span class="n">gridView</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> | u_h - u | =&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:0.5e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s1">&#39;, eoc =&#39;</span><span class="p">,</span> <span class="n">eocs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> | grad(uh - u) | =&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:0.5e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s1">&#39;, eoc =&#39;</span><span class="p">,</span> <span class="n">eocs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">u_h</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">eocLoop</span> <span class="o">&lt;</span> <span class="n">loops</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">gridView</span><span class="o">.</span><span class="n">hierarchicalGrid</span><span class="o">.</span><span class="n">globalRefine</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dt</span><span class="o">.</span><span class="n">value</span> <span class="o">/=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Forchheimer: step: 0 , size: 16
         | u_h - u | = 1.55256e-04 , eoc = -
         | grad(uh - u) | = 3.99906e-03 , eoc = -
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/solvers_nb_7_1.jpg" src="_images/solvers_nb_7_1.jpg" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Forchheimer: step: 1 , size: 64
         | u_h - u | = 1.92874e-05 , eoc = 3.01
         | grad(uh - u) | = 9.99164e-04 , eoc = 2.0
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/solvers_nb_7_3.jpg" src="_images/solvers_nb_7_3.jpg" />
</div>
</div>
<section id="Using-Scipy">
<span id="index-0"></span><h2>Using Scipy<a class="headerlink" href="#Using-Scipy" title="Link to this heading"></a></h2>
<p>We implement a simple Newton Krylov solver using a linear solver from Scipy. We can use the <code class="docutils literal notranslate"><span class="pre">as_numpy</span></code> method to access the degrees of freedom as Numpy vector based on the <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">buffer</span> <span class="pre">protocol</span></code>. So no data is copied and changes to the dofs made on the Python side are automatically carried over to the C++ side.</p>
<p>The most important step is accessing the data structures setup on the C++ side in Python. In this case we would like to use the underlying dof vector from a discrete function as numpy arrays and system matrices assembled by the schemes and operators as scipy sparse matrices. In the <a class="reference internal" href="dune-fempy_nb.html"><span class="doc">introduction</span></a> we already discussed the <code class="docutils literal notranslate"><span class="pre">as_numpy</span></code> method. So</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vecu_h</span> <span class="o">=</span> <span class="n">u_h</span><span class="o">.</span><span class="n">as_numpy</span>
</pre></div>
</div>
</div>
<p>provides access to the underlying dof vector without copying. So changes to the numpy array <code class="docutils literal notranslate"><span class="pre">vecu_h</span></code> carries over to the discrete function <code class="docutils literal notranslate"><span class="pre">u_h</span></code>. Just remember to make changes using <code class="docutils literal notranslate"><span class="pre">vecu_h[:]</span></code> to change the actual memory buffer.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">scheme</span></code> describing an operator <code class="docutils literal notranslate"><span class="pre">L</span></code> provides a method <code class="docutils literal notranslate"><span class="pre">linear</span></code> which returns an object that stores a sparse matrix structure. The object describes the operator linearized around zero. To linearize around a different value use the <code class="docutils literal notranslate"><span class="pre">jacobian</span></code> method on the <code class="docutils literal notranslate"><span class="pre">scheme</span></code> that linearized the the operator <code class="docutils literal notranslate"><span class="pre">L</span></code> around a given grid function <code class="docutils literal notranslate"><span class="pre">ubar</span></code> and fills the linear operator structure passed in as second argument. It is also possible to pass <code class="docutils literal notranslate"><span class="pre">assemble=False</span></code> to the <code class="docutils literal notranslate"><span class="pre">linear</span></code> method to
avoid an the linearization around zero to reduce computational cost:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">linOp</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">linear</span><span class="p">()</span>                  <span class="c1"># linearized around 0</span>
<span class="n">linOp</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">assemble</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    <span class="c1"># empty (non valid) linear operator</span>
<span class="n">scheme</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">space</span><span class="o">.</span><span class="n">zero</span><span class="p">,</span> <span class="n">linOp</span><span class="p">)</span>       <span class="c1"># linearized around zero</span>
</pre></div>
</div>
</div>
<p>Here we linearize around zero. But that argument could be any grid function. A second version of this method will return an addition discrete function <code class="docutils literal notranslate"><span class="pre">rhs</span></code> which equals <code class="docutils literal notranslate"><span class="pre">-L[ubar]</span></code> such that <code class="docutils literal notranslate"><span class="pre">DL[ubar](u-ubar)</span> <span class="pre">-</span> <span class="pre">rhs</span></code> are the first terms in the Taylor expansion of the operator <code class="docutils literal notranslate"><span class="pre">L</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rhs</span> <span class="o">=</span> <span class="n">u_h</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">scheme</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">u_h</span><span class="p">,</span> <span class="n">linOp</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>One can now easily access the underlying sparse matrix by again using <code class="docutils literal notranslate"><span class="pre">as_numpy</span></code> (and again the underlying data buffers are not copied):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">A</span> <span class="o">=</span> <span class="n">linOp</span><span class="o">.</span><span class="n">as_numpy</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
<span class="c1"># plt.spy(A, precision=1e-8, markersize=1)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;class &#39;scipy.sparse._csr.csr_matrix&#39;&gt;
</pre></div></div>
</div>
<p>Now we have all the ingredients to write a simple Newton solver to solve our non-linear time dependent PDE.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">spsolve</span> <span class="k">as</span> <span class="n">solver</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Scheme</span><span class="p">:</span>
  <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheme</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">model</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">jacobian</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">linear</span><span class="p">()</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
      <span class="c1"># create a copy of target for the residual</span>
      <span class="n">res</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;residual&quot;</span><span class="p">)</span>

      <span class="c1"># extract numpy vectors from target and res</span>
      <span class="n">sol_coeff</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">as_numpy</span>
      <span class="n">res_coeff</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">as_numpy</span>

      <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
          <span class="n">scheme</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
          <span class="n">absF</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">res_coeff</span><span class="p">,</span><span class="n">res_coeff</span><span class="p">)</span> <span class="p">)</span>
          <span class="k">if</span> <span class="n">absF</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
              <span class="k">break</span>
          <span class="n">scheme</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">jacobian</span><span class="p">)</span>
          <span class="n">sol_coeff</span> <span class="o">-=</span> <span class="n">solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jacobian</span><span class="o">.</span><span class="n">as_numpy</span><span class="p">,</span> <span class="n">res_coeff</span><span class="p">)</span>
          <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">scheme_cls</span> <span class="o">=</span> <span class="n">Scheme</span><span class="p">(</span><span class="n">scheme</span><span class="p">)</span>

<span class="n">u_h</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span>                <span class="c1"># reset u_h to initial</span>
<span class="n">evolve</span><span class="p">(</span><span class="n">scheme_cls</span><span class="p">,</span> <span class="n">u_h</span><span class="p">,</span> <span class="n">u_h_n</span><span class="p">,</span> <span class="n">endTime</span><span class="p">)</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">u_h</span> <span class="o">-</span> <span class="n">exact_end</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Forchheimer(numpy) size: &quot;</span><span class="p">,</span> <span class="n">gridView</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;L^2, H^1 error:&quot;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">{:0.5e}</span><span class="s1">, </span><span class="si">{:0.5e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
  <span class="o">*</span><span class="p">[</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">integrate</span><span class="p">([</span><span class="n">error</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">error</span><span class="p">),</span><span class="n">grad</span><span class="p">(</span><span class="n">error</span><span class="p">))])</span> <span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Forchheimer(numpy) size:  64 L^2, H^1 error: 1.93091e-05, 9.99162e-04
</pre></div></div>
</div>
<p>We can also use a non linear solver from the Scipy package</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">newton_krylov</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearOperator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">cg</span> <span class="k">as</span> <span class="n">solver</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Scheme2</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheme</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="n">scheme</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="n">u_h</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;residual&quot;</span><span class="p">)</span>

    <span class="c1"># non linear function</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_coeff</span><span class="p">):</span>
        <span class="c1"># the following converts a given numpy array</span>
        <span class="c1"># into a discrete function over the given space</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">space</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="s2">&quot;tmp&quot;</span><span class="p">,</span> <span class="n">dofVector</span><span class="o">=</span><span class="n">x_coeff</span><span class="p">)</span>
        <span class="n">scheme</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">as_numpy</span>

    <span class="c1"># class for the derivative DS of S</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">Df</span><span class="p">(</span><span class="n">LinearOperator</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_coeff</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_coeff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_coeff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">x_coeff</span><span class="o">.</span><span class="n">dtype</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">space</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="s2">&quot;tmp&quot;</span><span class="p">,</span> <span class="n">dofVector</span><span class="o">=</span><span class="n">x_coeff</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jacobian</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">linear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x_coeff</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1"># reassemble the matrix DF(u) given a DoF vector for u</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_coeff</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">space</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="s2">&quot;tmp&quot;</span><span class="p">,</span> <span class="n">dofVector</span><span class="o">=</span><span class="n">x_coeff</span><span class="p">)</span>
            <span class="n">scheme</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jacobian</span><span class="p">)</span>
        <span class="c1"># compute DS(u)^{-1}x for a given DoF vector x</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_matvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_coeff</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jacobian</span><span class="o">.</span><span class="n">as_numpy</span><span class="p">,</span> <span class="n">x_coeff</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">sol_coeff</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">as_numpy</span>
        <span class="c1"># call the newton krylov solver from scipy</span>
        <span class="n">sol_coeff</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">newton_krylov</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="n">sol_coeff</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">f_tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
                    <span class="n">inner_M</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Df</span><span class="p">(</span><span class="n">sol_coeff</span><span class="p">))</span>

<span class="n">scheme2_cls</span> <span class="o">=</span> <span class="n">Scheme2</span><span class="p">(</span><span class="n">scheme</span><span class="p">)</span>
<span class="n">u_h</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span>
<span class="n">evolve</span><span class="p">(</span><span class="n">scheme2_cls</span><span class="p">,</span> <span class="n">u_h</span><span class="p">,</span> <span class="n">u_h_n</span><span class="p">,</span> <span class="n">endTime</span><span class="p">)</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">u_h</span> <span class="o">-</span> <span class="n">exact_end</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Forchheimer(scipy) size: &quot;</span><span class="p">,</span> <span class="n">gridView</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;L^2, H^1 error:&quot;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">{:0.5e}</span><span class="s1">, </span><span class="si">{:0.5e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
  <span class="o">*</span><span class="p">[</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">integrate</span><span class="p">([</span><span class="n">error</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">error</span><span class="p">),</span><span class="n">grad</span><span class="p">(</span><span class="n">error</span><span class="p">))])</span> <span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Forchheimer(scipy) size:  64 L^2, H^1 error: 1.93091e-05, 9.99162e-04
</pre></div></div>
</div>
</section>
<section id="Handling-Dirichlet-boundary-conditions">
<span id="index-2"></span><span id="index-1"></span><h2>Handling Dirichlet boundary conditions<a class="headerlink" href="#Handling-Dirichlet-boundary-conditions" title="Link to this heading"></a></h2>
<p>We look at a simple Poisson problem with Dirichlet BCs to show how to use external solvers like the cg method from Scipy in this case. We solve <span class="math notranslate nohighlight">\(-\triangle u=10\chi_\omega\)</span> where <span class="math notranslate nohighlight">\(\chi_\omega\)</span> is a characteristic function with <span class="math notranslate nohighlight">\(\omega=\{x\colon |x|^2&lt;0.6\}\)</span>. For the boundary we prescribe trivial Neuman at the top and bottom boundaries and Dirichlet values <span class="math notranslate nohighlight">\(u=-1\)</span> and <span class="math notranslate nohighlight">\(u=1\)</span> at the left and right boundaries, respectively. We will use the CG solver from
<code class="docutils literal notranslate"><span class="pre">scipy.sparse.linalg</span></code>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Since we are not needing to invert the operator we will use the <code class="docutils literal notranslate"><span class="pre">dune.fem.operator.galerkin</span></code> class to setup the problem. This is similar to <code class="docutils literal notranslate"><span class="pre">dune.fem.scheme.galerkin</span></code> we have been using so far but can be used to model operators between different spaces. See <a class="reference internal" href="scheme_api.html"><span class="doc">here</span></a> for a summary of the concepts and API for operators and schemes.</p>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dune.ufl</span><span class="w"> </span><span class="kn">import</span> <span class="n">DirichletBC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dune.fem.operator</span><span class="w"> </span><span class="kn">import</span> <span class="n">galerkin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">cg</span> <span class="k">as</span> <span class="n">solver</span>
<span class="n">model</span> <span class="o">=</span> <span class="p">(</span> <span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">-</span>
          <span class="n">conditional</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">10.</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span> <span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
<span class="n">dbcs</span>  <span class="o">=</span> <span class="p">[</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">space</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">]</span>
<span class="n">op</span>  <span class="o">=</span> <span class="n">galerkin</span><span class="p">([</span><span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">dbcs</span><span class="p">],</span> <span class="n">space</span><span class="p">)</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">space</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;u_h&quot;</span><span class="p">)</span>
<span class="n">rhs</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">lin</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">linear</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>So far everything is as before. Dirichlet boundary conditions are handled in the matrix through changing all rows associated with boundary degrees of freedom to unit rows - associated columns are not changed so the matrix will not be symmetric anymore. For solving the system we need to modify the right hand side and the initial guess for the iterative solver to include the boundary values (to counter the missing symmetry). We can use the first of the three versions of the <code class="docutils literal notranslate"><span class="pre">setConstraints</span></code>
methods on the scheme class discussed in the section on <a class="reference internal" href="boundary_nb.html#Accessing-the-Dirichlet-degrees-of-freedom"><span class="std std-ref">more general boundary conditions</span></a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">op</span><span class="o">.</span><span class="n">setConstraints</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
<span class="n">op</span><span class="o">.</span><span class="n">setConstraints</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span>
<span class="n">rk</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s2">&quot;residual&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cb</span><span class="p">(</span><span class="n">xk</span><span class="p">):</span> <span class="c1"># a callback to print the residual norm in each step</span>
    <span class="n">x_h</span> <span class="o">=</span> <span class="n">space</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="s2">&quot;iterate&quot;</span><span class="p">,</span> <span class="n">dofVector</span><span class="o">=</span><span class="n">xk</span><span class="p">)</span>
    <span class="n">op</span><span class="p">(</span><span class="n">x_h</span><span class="p">,</span><span class="n">rk</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">rk</span><span class="o">.</span><span class="n">as_numpy</span><span class="p">[:]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rk</span><span class="o">.</span><span class="n">as_numpy</span><span class="p">[:]),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">sol</span><span class="o">.</span><span class="n">as_numpy</span><span class="p">[:],</span> <span class="n">_</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">lin</span><span class="o">.</span><span class="n">as_numpy</span><span class="p">,</span> <span class="n">rhs</span><span class="o">.</span><span class="n">as_numpy</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">as_numpy</span><span class="p">,</span>
                            <span class="n">callback</span><span class="o">=</span><span class="n">cb</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span>
<span class="n">sol</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
22.364801469753214      6.5503071305549865      5.5020389790076845      2.651703574864195       2.847846537860448       1.3560658457805435      1.6365176519674605      1.1996200851668588      0.849170828428025       0.4116851221505151      0.3318991774651997      0.2518006403242052      0.23615171539855195     0.22530579266807363     0.2214195904289021      0.21926871065555859     0.21829153537638452     0.21653684764907868     0.21675782107045938     0.2158110638718003      0.21559315250503033     0.21544432425537108     0.21544150394440717     0.2153861339325574      0.21538859378926503     0.21538505227526789     0.21538418947503998     0.21538241666417576     0.21538282256904034     0.21538287372050155     0.21538276135478887     0.21538277558134716     0.21538281353457012     0.21538283870317626     0.2153828390521391      0.21538283539716077     0.21538283650631837     0.21538283693719715     0.2153828375348075      0.21538283758833912     0.21538283758714327     0.21538283755554377
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/solvers_nb_24_1.jpg" src="_images/solvers_nb_24_1.jpg" />
</div>
</div>
</section>
<section id="Using-PETSc-and-Petsc4Py">
<span id="index-3"></span><h2>Using PETSc and Petsc4Py<a class="headerlink" href="#Using-PETSc-and-Petsc4Py" title="Link to this heading"></a></h2>
<p>The following requires that a PETSc installation was found during the configuration of <code class="docutils literal notranslate"><span class="pre">dune</span></code>. Furthermore some examples make use of the Python package `<code class="docutils literal notranslate"><span class="pre">petsc4py</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dune.common.checkconfiguration</span><span class="w"> </span><span class="kn">import</span> <span class="n">assertCMakeHave</span><span class="p">,</span> <span class="n">ConfigurationError</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">assertCMakeHave</span><span class="p">(</span><span class="s2">&quot;HAVE_PETSC&quot;</span><span class="p">)</span>
    <span class="n">petsc</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="n">ConfigurationError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dune not configured with petsc - skipping example&quot;</span><span class="p">)</span>
    <span class="n">petsc</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">petsc4py</span>
    <span class="n">petsc4py</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">petsc4py</span><span class="w"> </span><span class="kn">import</span> <span class="n">PETSc</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;petsc4py module not found -- skipping example&quot;</span><span class="p">)</span>
    <span class="n">petsc4py</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
<p>Switching to a storage based on the PETSc solver package and solving the system using the dune-fem bindings can be achieved by using the <code class="docutils literal notranslate"><span class="pre">storage</span></code> argument to the space constructor</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">petsc</span><span class="p">:</span>
    <span class="n">spacePetsc</span> <span class="o">=</span> <span class="n">solutionSpace</span><span class="p">(</span><span class="n">gridView</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">storage</span><span class="o">=</span><span class="s1">&#39;petsc&#39;</span><span class="p">)</span>
    <span class="c1"># first we will use the petsc solver available in the `dune-fem` package</span>
    <span class="c1"># (using the sor preconditioner)</span>
    <span class="n">schemePetsc</span> <span class="o">=</span> <span class="n">solutionScheme</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">,</span> <span class="n">space</span><span class="o">=</span><span class="n">spacePetsc</span><span class="p">,</span>
                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;linear.preconditioning.method&quot;</span><span class="p">:</span><span class="s2">&quot;sor&quot;</span><span class="p">})</span>
    <span class="n">dt</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dt</span>
    <span class="n">u_h</span> <span class="o">=</span> <span class="n">spacePetsc</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;u_h&#39;</span><span class="p">)</span>
    <span class="n">u_h_n</span> <span class="o">=</span> <span class="n">u_h</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;previous&quot;</span><span class="p">)</span>
    <span class="n">evolve</span><span class="p">(</span><span class="n">schemePetsc</span><span class="p">,</span> <span class="n">u_h</span><span class="p">,</span> <span class="n">u_h_n</span><span class="p">,</span> <span class="n">endTime</span><span class="p">)</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">u_h</span> <span class="o">-</span> <span class="n">exact_end</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Forchheimer(petsc) size: &quot;</span><span class="p">,</span> <span class="n">gridView</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;L^2, H^1 error:&quot;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">{:0.5e}</span><span class="s1">, </span><span class="si">{:0.5e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
      <span class="o">*</span><span class="p">[</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">integrate</span><span class="p">([</span><span class="n">error</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">error</span><span class="p">),</span><span class="n">grad</span><span class="p">(</span><span class="n">error</span><span class="p">))])</span> <span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Forchheimer(petsc) size:  64 L^2, H^1 error: 1.93079e-05, 9.99164e-04
</pre></div></div>
</div>
<p>Implementing a Newton Krylov solver using the binding provided by petsc4py</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">petsc4py</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">petsc</span><span class="p">:</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">Scheme3</span><span class="p">:</span>
      <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheme</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">model</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">jacobian</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">linear</span><span class="p">()</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">ksp</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">KSP</span><span class="p">()</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">ksp</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
          <span class="c1"># use conjugate gradients method</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">ksp</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="s2">&quot;cg&quot;</span><span class="p">)</span>
          <span class="c1"># and incomplete Cholesky</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">ksp</span><span class="o">.</span><span class="n">getPC</span><span class="p">()</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="s2">&quot;icc&quot;</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">ksp</span><span class="o">.</span><span class="n">setOperators</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jacobian</span><span class="o">.</span><span class="n">as_petsc</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">ksp</span><span class="o">.</span><span class="n">setFromOptions</span><span class="p">()</span>
      <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
          <span class="n">res</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;residual&quot;</span><span class="p">)</span>
          <span class="n">sol_coeff</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">as_petsc</span>
          <span class="n">res_coeff</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">as_petsc</span>
          <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
              <span class="n">schemePetsc</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
              <span class="n">absF</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">res_coeff</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">res_coeff</span><span class="p">)</span> <span class="p">)</span>
              <span class="k">if</span> <span class="n">absF</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
                  <span class="k">break</span>
              <span class="n">schemePetsc</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jacobian</span><span class="p">)</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">ksp</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">res_coeff</span><span class="p">,</span> <span class="n">res_coeff</span><span class="p">)</span>
              <span class="n">sol_coeff</span> <span class="o">-=</span> <span class="n">res_coeff</span>
              <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">u_h</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span>
    <span class="n">scheme3_cls</span> <span class="o">=</span> <span class="n">Scheme3</span><span class="p">(</span><span class="n">schemePetsc</span><span class="p">)</span>
    <span class="n">evolve</span><span class="p">(</span><span class="n">scheme3_cls</span><span class="p">,</span> <span class="n">u_h</span><span class="p">,</span> <span class="n">u_h_n</span><span class="p">,</span> <span class="n">endTime</span><span class="p">)</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">u_h</span> <span class="o">-</span> <span class="n">exact_end</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Forchheimer(petsc) size: &quot;</span><span class="p">,</span> <span class="n">gridView</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;L^2, H^1 error:&quot;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">{:0.5e}</span><span class="s1">, </span><span class="si">{:0.5e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
      <span class="o">*</span><span class="p">[</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">integrate</span><span class="p">([</span><span class="n">error</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">error</span><span class="p">),</span><span class="n">grad</span><span class="p">(</span><span class="n">error</span><span class="p">))])</span> <span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Forchheimer(petsc) size:  64 L^2, H^1 error: 1.93091e-05, 9.99162e-04
</pre></div></div>
</div>
<p>Using the petsc4py bindings for the non linear KSP solvers from PETSc</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">petsc4py</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">petsc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">Scheme4</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheme</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">interpolate</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;residual&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="n">scheme</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jacobian</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">linear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snes</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">SNES</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snes</span><span class="o">.</span><span class="n">setFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">as_petsc</span><span class="o">.</span><span class="n">duplicate</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snes</span><span class="o">.</span><span class="n">setUseMF</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snes</span><span class="o">.</span><span class="n">setJacobian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jacobian</span><span class="o">.</span><span class="n">as_petsc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jacobian</span><span class="o">.</span><span class="n">as_petsc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snes</span><span class="o">.</span><span class="n">getKSP</span><span class="p">()</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="s2">&quot;cg&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snes</span><span class="o">.</span><span class="n">setFromOptions</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snes</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
            <span class="c1"># setup discrete function using the provide petsc vectors</span>
            <span class="n">inDF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="s2">&quot;tmp&quot;</span><span class="p">,</span><span class="n">dofVector</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
            <span class="n">outDF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="s2">&quot;tmp&quot;</span><span class="p">,</span><span class="n">dofVector</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">(</span><span class="n">inDF</span><span class="p">,</span><span class="n">outDF</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">Df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snes</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="n">inDF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="s2">&quot;tmp&quot;</span><span class="p">,</span><span class="n">dofVector</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">inDF</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jacobian</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Mat</span><span class="o">.</span><span class="n">Structure</span><span class="o">.</span><span class="n">SAME_NONZERO_PATTERN</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
            <span class="n">sol_coeff</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">as_petsc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snes</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">as_petsc</span><span class="p">,</span> <span class="n">sol_coeff</span><span class="p">)</span>

    <span class="n">u_h</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span>
    <span class="n">scheme4_cls</span> <span class="o">=</span> <span class="n">Scheme4</span><span class="p">(</span><span class="n">schemePetsc</span><span class="p">)</span>
    <span class="n">evolve</span><span class="p">(</span><span class="n">scheme4_cls</span><span class="p">,</span> <span class="n">u_h</span><span class="p">,</span> <span class="n">u_h_n</span><span class="p">,</span> <span class="n">endTime</span><span class="p">)</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">u_h</span> <span class="o">-</span> <span class="n">exact_end</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Forchheimer(petsc4py) size: &quot;</span><span class="p">,</span> <span class="n">gridView</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;L^2, H^1 error:&quot;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">{:0.5e}</span><span class="s1">, </span><span class="si">{:0.5e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
      <span class="o">*</span><span class="p">[</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">integrate</span><span class="p">([</span><span class="n">error</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">error</span><span class="p">),</span><span class="n">grad</span><span class="p">(</span><span class="n">error</span><span class="p">))])</span> <span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Forchheimer(petsc4py) size:  64 L^2, H^1 error: 1.93091e-05, 9.99162e-04
</pre></div></div>
</div>
</section>
<section id="Accessing-and-reusing-values-of-parameters">
<span id="index-4"></span><h2>Accessing and reusing values of parameters<a class="headerlink" href="#Accessing-and-reusing-values-of-parameters" title="Link to this heading"></a></h2>
<p>Sometimes it is necessary to extract which parameters were read and which values were used, e.g., for debugging purposes like finding spelling in the parameters provided to a scheme. Note that this information can only be reliably obtained after usage of the scheme, e.g., after calling solve as shown in the example below. To add logging to a set of parameters passed to a <code class="docutils literal notranslate"><span class="pre">scheme</span></code> one simply needs to add a <code class="docutils literal notranslate"><span class="pre">logging</span></code> key to the parameter dictionary provided to the scheme with a tag (string)
that is used in the output.</p>
<p>As an example we will solve the simple Laplace equation from the introduction but pass some preconditioning parameters to the scheme.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dune.fem</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dune.grid</span><span class="w"> </span><span class="kn">import</span> <span class="n">structuredGrid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dune.fem.space</span><span class="w"> </span><span class="kn">import</span> <span class="n">lagrange</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dune.fem.scheme</span><span class="w"> </span><span class="kn">import</span> <span class="n">galerkin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufl</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">TestFunction</span><span class="p">,</span> <span class="n">TrialFunction</span><span class="p">,</span> <span class="n">SpatialCoordinate</span><span class="p">,</span>
                 <span class="n">dx</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">inner</span><span class="p">,</span> <span class="n">dot</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">pi</span> <span class="p">)</span>
<span class="n">gridView</span> <span class="o">=</span> <span class="n">structuredGrid</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>
<span class="n">space</span> <span class="o">=</span> <span class="n">lagrange</span><span class="p">(</span><span class="n">gridView</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">storage</span><span class="o">=</span><span class="s2">&quot;istl&quot;</span><span class="p">)</span>
<span class="n">u_h</span>   <span class="o">=</span> <span class="n">space</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;u_h&#39;</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">SpatialCoordinate</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">(</span> <span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span><span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">+</span> <span class="n">u</span><span class="o">*</span><span class="n">v</span> <span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
<span class="n">l</span> <span class="o">=</span> <span class="n">f</span><span class="o">*</span><span class="n">v</span> <span class="o">*</span> <span class="n">dx</span>
<span class="n">scheme</span> <span class="o">=</span> <span class="n">galerkin</span><span class="p">(</span> <span class="n">a</span><span class="o">==</span><span class="n">l</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s2">&quot;cg&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span>
                   <span class="p">{</span><span class="s2">&quot;newton.linear.tolerance&quot;</span><span class="p">:</span> <span class="mf">1e-12</span><span class="p">,</span>
                    <span class="s2">&quot;newton.linear.verbose&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;newton.linear.preconditioning.method&quot;</span><span class="p">:</span> <span class="s2">&quot;amg-ilu&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;fem.solver.newton.linear.errormeasure&quot;</span><span class="p">:</span> <span class="s2">&quot;relative&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;logging&quot;</span><span class="p">:</span> <span class="s2">&quot;precon-amg&quot;</span>
                   <span class="p">}</span> <span class="p">)</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">u_h</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
=== Dune::CGSolver
 Iter          Defect            Rate
    0          0.19886
    1         0.138041         0.694164
    2        0.0533951         0.386805
    3        0.0335279         0.627921
    4       0.00936836          0.27942
    5        0.0158677          1.69376
    6       0.00553746         0.348977
    7       0.00407438         0.735784
    8       0.00238342         0.584978
    9       0.00097925         0.410859
   10       0.00030568         0.312157
   11      0.000177396         0.580333
   12      4.54516e-05         0.256215
   13      2.72129e-05         0.598721
   14        2.549e-05         0.936688
   15      1.32301e-05          0.51903
   16      7.51289e-06         0.567865
   17      2.13798e-06         0.284575
   18      1.08267e-06         0.506398
   19      7.67007e-07         0.708442
   20      2.79923e-07         0.364955
   21      5.71861e-08         0.204292
   22       2.5419e-08         0.444496
   23      1.38267e-08         0.543951
   24      6.60951e-09         0.478026
   25      1.93829e-09         0.293257
   26      6.68847e-10         0.345072
   27      3.43101e-10         0.512974
   28      1.06161e-10         0.309416
   29       2.6079e-11         0.245655
   30      4.90648e-12         0.188139
   31      6.17261e-12          1.25805
   32      2.10807e-12         0.341519
   33      9.47557e-13         0.449491
=== rate=0.453848, T=0.228761, TIT=0.00693215, IT=33
</pre></div></div>
</div>
<p>We use the <code class="docutils literal notranslate"><span class="pre">pprint</span></code> (pretty print) module if available to get nicer output.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pprint</span><span class="w"> </span><span class="kn">import</span> <span class="n">pprint</span> <span class="k">as</span> <span class="n">_pprint</span>
    <span class="n">pprint</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">_pprint</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">pprint</span> <span class="o">=</span> <span class="nb">print</span>

<span class="n">pprint</span><span class="p">(</span><span class="n">dune</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">log</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;default&#39;: {(&#39;fem.dofmanager.memoryfactor&#39;, &#39;1.1&#39;), (&#39;fem.threads.communicationthread&#39;, &#39;false&#39;), (&#39;fem.dofmanager.clearresizedarrays&#39;, &#39;true&#39;)},
 &#39;precon-amg&#39;: {(&#39;fem.solver.newton.lineSearch&#39;, &#39;none&#39;),
                (&#39;fem.solver.newton.linear.errormeasure&#39;, &#39;absolute&#39;),
                (&#39;fem.solver.newton.linear.matrix.overflowfraction&#39;, &#39;1&#39;),
                (&#39;fem.solver.newton.linear.maxiterations&#39;, &#39;2147483647&#39;),
                (&#39;fem.solver.newton.linear.preconditioning.iterations&#39;, &#39;1&#39;),
                (&#39;fem.solver.newton.linear.preconditioning.relaxation&#39;, &#39;1.1&#39;),
                (&#39;fem.solver.newton.linear.threading&#39;, &#39;true&#39;),
                (&#39;fem.solver.newton.linear.tolerance.strategy&#39;, &#39;none&#39;),
                (&#39;fem.solver.newton.maxiterations&#39;, &#39;2147483647&#39;),
                (&#39;fem.solver.newton.maxlinesearchiterations&#39;, &#39;2147483647&#39;),
                (&#39;fem.solver.newton.tolerance&#39;, &#39;1e-06&#39;),
                (&#39;fem.solver.newton.verbose&#39;, &#39;false&#39;),
                (&#39;newton.linear.method&#39;, &#39;cg&#39;),
                (&#39;newton.linear.preconditioning.method&#39;, &#39;amg-ilu&#39;),
                (&#39;newton.linear.tolerance&#39;, &#39;1e-12&#39;),
                (&#39;newton.linear.verbose&#39;, &#39;True&#39;)},
 &#39;program code&#39;: {(&#39;fem.adaptation.method&#39;, &#39;callback&#39;)}}
</pre></div></div>
</div>
<p>Note above that all parameters are printed including some default ones used in other parts of the code. If multiple schemes with different <code class="docutils literal notranslate"><span class="pre">logging</span></code> parameter strings are used, all would be shown using the <code class="docutils literal notranslate"><span class="pre">log</span></code> method as shown above. To access only the parameters used in the scheme simply use either <code class="docutils literal notranslate"><span class="pre">dune.fem.parameter.log()[&quot;tag&quot;])</span></code> or access the parameter log through the scheme:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">scheme</span><span class="o">.</span><span class="n">parameterLog</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{(&#39;fem.solver.newton.lineSearch&#39;, &#39;none&#39;),
 (&#39;fem.solver.newton.linear.errormeasure&#39;, &#39;absolute&#39;),
 (&#39;fem.solver.newton.linear.matrix.overflowfraction&#39;, &#39;1&#39;),
 (&#39;fem.solver.newton.linear.maxiterations&#39;, &#39;2147483647&#39;),
 (&#39;fem.solver.newton.linear.preconditioning.iterations&#39;, &#39;1&#39;),
 (&#39;fem.solver.newton.linear.preconditioning.relaxation&#39;, &#39;1.1&#39;),
 (&#39;fem.solver.newton.linear.threading&#39;, &#39;true&#39;),
 (&#39;fem.solver.newton.linear.tolerance.strategy&#39;, &#39;none&#39;),
 (&#39;fem.solver.newton.maxiterations&#39;, &#39;2147483647&#39;),
 (&#39;fem.solver.newton.maxlinesearchiterations&#39;, &#39;2147483647&#39;),
 (&#39;fem.solver.newton.tolerance&#39;, &#39;1e-06&#39;),
 (&#39;fem.solver.newton.verbose&#39;, &#39;false&#39;),
 (&#39;newton.linear.method&#39;, &#39;cg&#39;),
 (&#39;newton.linear.preconditioning.method&#39;, &#39;amg-ilu&#39;),
 (&#39;newton.linear.tolerance&#39;, &#39;1e-12&#39;),
 (&#39;newton.linear.verbose&#39;, &#39;True&#39;)}
</pre></div></div>
</div>
<p>One can easily reuse these parameters to construct another scheme by converting the result of the above call to a dictionary. As an example change the above problem to a PDE with Dirichlet conditions but turn of verbose output of the solver.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>the <code class="docutils literal notranslate"><span class="pre">logging</span></code> parameter has to be set if we want to use the <code class="docutils literal notranslate"><span class="pre">parameterLog</span></code> method on the scheme.</p>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">scheme</span><span class="o">.</span><span class="n">parameterLog</span><span class="p">())</span> <span class="c1"># this method returns a set of pairs which we can convert to a dictionary</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;logging&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Dirichlet&quot;</span> <span class="c1"># only needed to use the `parameterLog` method</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;newton.linear.verbose&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">scheme2</span> <span class="o">=</span> <span class="n">galerkin</span><span class="p">(</span> <span class="p">[</span><span class="n">a</span><span class="o">==</span><span class="n">l</span><span class="p">,</span><span class="n">DirichletBC</span><span class="p">(</span><span class="n">space</span><span class="p">,</span><span class="mi">0</span><span class="p">)],</span> <span class="n">parameters</span><span class="o">=</span><span class="n">param</span> <span class="p">)</span>
<span class="n">u_h</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">scheme2</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">u_h</span><span class="p">)</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">scheme2</span><span class="o">.</span><span class="n">parameterLog</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{(&#39;fem.solver.newton.lineSearch&#39;, &#39;none&#39;),
 (&#39;fem.solver.newton.linear.errormeasure&#39;, &#39;absolute&#39;),
 (&#39;fem.solver.newton.linear.matrix.overflowfraction&#39;, &#39;1&#39;),
 (&#39;fem.solver.newton.linear.maxiterations&#39;, &#39;2147483647&#39;),
 (&#39;fem.solver.newton.linear.preconditioning.iterations&#39;, &#39;1&#39;),
 (&#39;fem.solver.newton.linear.preconditioning.relaxation&#39;, &#39;1.1&#39;),
 (&#39;fem.solver.newton.linear.threading&#39;, &#39;true&#39;),
 (&#39;fem.solver.newton.linear.tolerance.strategy&#39;, &#39;none&#39;),
 (&#39;fem.solver.newton.maxiterations&#39;, &#39;2147483647&#39;),
 (&#39;fem.solver.newton.maxlinesearchiterations&#39;, &#39;2147483647&#39;),
 (&#39;fem.solver.newton.tolerance&#39;, &#39;1e-06&#39;),
 (&#39;fem.solver.newton.verbose&#39;, &#39;false&#39;),
 (&#39;newton.linear.method&#39;, &#39;cg&#39;),
 (&#39;newton.linear.preconditioning.method&#39;, &#39;amg-ilu&#39;),
 (&#39;newton.linear.tolerance&#39;, &#39;1e-12&#39;),
 (&#39;newton.linear.verbose&#39;, &#39;False&#39;)}
</pre></div></div>
</div>
<section id="Parameter-hints">
<h3>Parameter hints<a class="headerlink" href="#Parameter-hints" title="Link to this heading"></a></h3>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>To get information about available values for some parameters (those with string arguments) a possible approach is to provide a non valid string, e.g., <code class="docutils literal notranslate"><span class="pre">&quot;help&quot;</span></code>.</p>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scheme</span> <span class="o">=</span> <span class="n">galerkin</span><span class="p">(</span> <span class="n">a</span><span class="o">==</span><span class="n">l</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s2">&quot;cg&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span>
                   <span class="p">{</span><span class="s2">&quot;newton.linear.tolerance&quot;</span><span class="p">:</span> <span class="mf">1e-12</span><span class="p">,</span>
                    <span class="s2">&quot;newton.linear.verbose&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;newton.linear.preconditioning.method&quot;</span><span class="p">:</span> <span class="s2">&quot;help&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;fem.solver.newton.linear.errormeasure&quot;</span><span class="p">:</span> <span class="s2">&quot;relative&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;logging&quot;</span><span class="p">:</span> <span class="s2">&quot;precon-amg&quot;</span>
                   <span class="p">}</span> <span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">scheme</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">u_h</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">rte</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">rte</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ParameterInvalid [getEnumeration:/home/dedner/DUNE_PYTHON/dune-fem/dune/fem/io/parameter/reader.hh:301]: Parameter &#39;fem.solver.newton.linear.preconditioning.method&#39; invalid.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

Parameter &#39;fem.solver.newton.linear.preconditioning.method&#39; invalid.
Valid values are: none, ssor, sor, ilu, gauss-seidel, jacobi, amg-ilu, amg-jacobi, ildl

</pre></div></div>
</div>
</section>
</section>
<section id="Available-solvers-and-parameters">
<span id="index-5"></span><h2>Available solvers and parameters<a class="headerlink" href="#Available-solvers-and-parameters" title="Link to this heading"></a></h2>
<p>Upon creation of a discrete function space one also have to specifies the storage which is tied to the solver backend. As mentioned, different linear algebra backends can be accessed by changing setting the <code class="docutils literal notranslate"><span class="pre">storage</span></code> parameter during construction of the discrete space. All discrete functions and operators/schemes based on this space will then use this backend. Available backends are <code class="docutils literal notranslate"><span class="pre">numpy,istl,petsc</span></code>. Note that not all methods which are available in <code class="docutils literal notranslate"><span class="pre">dune-istl</span></code> or <code class="docutils literal notranslate"><span class="pre">PETSc</span></code> have been
forwarded to be used with <code class="docutils literal notranslate"><span class="pre">dune-fem</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">space</span> <span class="o">=</span> <span class="n">solutionSpace</span><span class="p">(</span><span class="n">gridView</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">storage</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Switching is as simple as passing <code class="docutils literal notranslate"><span class="pre">storage='istl'</span></code> or <code class="docutils literal notranslate"><span class="pre">storage='petsc'</span></code>. Here is a summary of the available backends</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Solver</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>numpy</p></td>
<td><p>the storage is based on a raw C pointer which can be</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>directly accessed as a numpy.array using the Python buffer protocol</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>To change the underlying vector of a discrete function ‘u_h’ use</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>‘uh.as_numpy[:]’.</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>As shown in the examples, linear operators return a</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">scipy.sparse.csr_matrix</span></code> through the ‘as_numpy’ property.</p></td>
</tr>
<tr class="row-even"><td><p>istl</p></td>
<td><p>data is stored in a block vector/matrix from the dune.istl package</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>Access through ‘as_istl’</p></td>
</tr>
<tr class="row-even"><td><p>petsc</p></td>
<td><p>data is stored in a petsc vector/matrix which can also be used with</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>petsc4py on the python side using ‘as_petsc’</p></td>
</tr>
</tbody>
</table>
<p id="index-6">When creating a scheme, there is the possibility to select a linear solver for the internal Newton method. In addition the behavior of the solver can be customized through a parameter dictionary. This allows to set tolerances, verbosity, but also which preconditioner to use.</p>
<p>For details see the help available for a scheme:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">scheme</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Help on Scheme in module dune.generated.femscheme_9b7005253a7d0b23b665ce4b07198dde object:

class Scheme(pybind11_builtins.pybind11_object)
 |  A scheme finds a solution `u=ufl.TrialFunction` for a given variational equation.
 |  The main method is `solve` which takes a discrete functions as `target` argument to
 |  store the solution. The method always uses a Newton method to solve the problem.
 |  The linear solver used in each iteration of the Newton method can be chosen
 |  using the `solver` parameter in the constructor of the scheme. Available solvers are:
 |  ------------------------------------------
 |  |  Solver  |         Storage             |
 |  |   name   |  numpy  |  istl   |  petsc  |
 |  |----------|---------|---------|---------|
 |  | bicg     |   ---   |   ---   |    x    |
 |  | bicgstab |    x    |    x    |    x    |
 |  | cg       |    x    |    x    |    x    |
 |  | gmres    |    x    |    x    |    x    |
 |  | gradient |   ---   |    x    |   ---   |
 |  | loop     |   ---   |    x    |   ---   |
 |  | minres   |   ---   |    x    |    x    |
 |  | preonly  |   ---   |   ---   |    x    |
 |  | superlu  |   ---   |    x    |   ---   |
 |  ------------------------------------------
 |
 |  In addition the direct solvers from the `suitesparse` package can be used with the
 |  `numpy` storage. In this case provide a tuple as `solver` argument with &#34;suitesparse&#34; as
 |  first argument and the solver to use as second, e.g.,
 |  &#39;solver=(&#34;suitesparse&#34;,&#34;umfpack&#34;)&#39;.
 |
 |  The detailed behavior of the schemes can be customized by providing a
 |  `parameters` dictionary to the scheme constructor, e.g.,
 |     {&#34;newton.tolerance&#34;: 1e-3, # tolerance for newton solver
 |      &#34;newton.verbose&#34;: False,  # toggle iteration output
 |      &#34;newton.linear.tolerance&#34;: 1e-5, # tolerance for linear solver
 |      &#34;newton.linear.errormeasure&#34;: &#34;absolute&#34;, # or &#34;relative&#34; or &#34;residualreduction&#34;
 |      &#34;newton.linear.preconditioning.method&#34;: &#34;jacobi&#34;, # (see table below)
 |      &#34;newton.linear.preconditioning.hypre.method&#34;: &#34;boomeramg&#34;, #  &#34;pilu-t&#34; &#34;parasails&#34;
 |      &#34;newton.linear.preconditioning.iteration&#34;: 3, # iterations for preconditioner
 |      &#34;newton.linear.preconditioning.relaxation&#34;: 1.0, # omega for SOR and ILU
 |      &#34;newton.linear.maxiterations&#34;:1000, # max number of linear iterations
 |      &#34;newton.linear.verbose&#34;: False,     # toggle linear iteration output
 |      &#34;newton.linear.preconditioning.level&#34;: 0} # fill-in level for ILU preconditioning
 |  -----------------------------------------------
 |  |  Precondition | (x = parallel | s = serial) |
 |  |  method       |  numpy  |   istl  |  petsc  |
 |  |---------------|---------|---------|---------|
 |  | amg-ilu       |   ---   |    x    |   ---   |
 |  | amg-jacobi    |   ---   |    x    |   ---   |
 |  | gauss-seidel  |    x    |    x    |    x    |
 |  | hypre         |   ---   |   ---   |    x    |
 |  | icc           |   ---   |   ---   |    x    |
 |  | ildl          |   ---   |    x    |   ---   |
 |  | ilu           |   ---   |    s    |    s    |
 |  | jacobi        |    x    |    x    |    x    |
 |  | kspoptions    |   ---   |   ---   |    x    |
 |  | lu            |   ---   |   ---   |    s    |
 |  | ml            |   ---   |   ---   |    x    |
 |  | none          |    x    |    x    |    x    |
 |  | oas           |   ---   |   ---   |    x    |
 |  | pcgamg        |   ---   |   ---   |    x    |
 |  | sor           |    x    |    x    |    x    |
 |  | ssor          |    x    |    x    |    x    |
 |  -----------------------------------------------
 |
 |  The functionality of some of the preconditioners listed for petsc will
 |  depend on the petsc installation.
 |
 |  Method resolution order:
 |      Scheme
 |      pybind11_builtins.pybind11_object
 |      builtins.object
 |
 |  Methods defined here:
 |
 |  __call__(...)
 |
 |  __init__(...)
 |
 |  dirichletIndices = _opDirichletIndices(self, id=None)
 |
 |  inverseLinearOperator(...)
 |
 |  jacobian(...)
 |
 |  linear = _schemeLinear(self, assemble=True, parameters=None)
 |
 |  setErrorMeasure(...)
 |
 |  setQuadratureOrders(...)
 |
 |  solve(scheme, target, rhs=None)
 |
 |  ----------------------------------------------------------------------
 |  Readonly properties defined here:
 |
 |  cppIncludes
 |
 |  cppTypeName
 |
 |  dimRange
 |
 |  domainSpace
 |
 |  parameterHelp
 |
 |  rangeSpace
 |
 |  space
 |
 |  ----------------------------------------------------------------------
 |  Data descriptors defined here:
 |
 |  __dict__
 |
 |  ----------------------------------------------------------------------
 |  Data and other attributes defined here:
 |
 |  LinearInverseOperator = &lt;class &#39;dune.generated.femscheme_9b7005253a7d0...
 |
 |
 |  ----------------------------------------------------------------------
 |  Static methods inherited from pybind11_builtins.pybind11_object:
 |
 |  __new__(*args, **kwargs) from pybind11_builtins.pybind11_type
 |      Create and return a new object.  See help(type) for accurate signature.

</pre></div></div>
</div>
</section>
</section>
<div class="admonition note">
<p class="admonition-title">Note</p>
This document is part of the dune-fem tutorial
<a href="https://doi.org/10.5281/zenodo.3706994"><img src="https://zenodo.org/badge/DOI/10.5281/zenodo.3706994.svg" alt="DOI"></a><div class="line-block">
<div class="line">Download <em>solvers</em> as <a class="reference download internal" download="" href="_downloads/c87c744d47d993b3149040ed4bd059d6/solvers_nb.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Jupyter</span> <span class="pre">notebook</span> <span class="pre">(.ipynb)</span></code></a> or as <a class="reference download internal" download="" href="_downloads/f01767f691faeef7cb79fe37604b8b26/solvers.py"><code class="xref download docutils literal notranslate"><span class="pre">Python</span> <span class="pre">script</span> <span class="pre">(.py)</span></code></a></div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="boundary_nb.html" class="btn btn-neutral float-left" title="More General Boundary Conditions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="othergrids_nb.html" class="btn btn-neutral float-right" title="Examples of grid construction" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2025, Andreas Dedner and Robert Klöfkorn.
      <span class="lastupdated">Last updated on Nov 26, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script> 

</body>
</html>