

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monolithic solver (Lagrange and DG formulation) &mdash; Tutorial for version 2.11-git</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/nbsphinx-code-cells.css?v=2aa19091" />

  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Stokes problem with fieldsplit preconditioner (PETSc)" href="fieldsplitStokes_nb.html" />
    <link rel="prev" title="Saddle point solver for the stationary Stokes problem" href="stokes.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html">
            
              <img src="_static/dune-python-logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
     <span class="caption-text">
     <li><u><a href="genindex.html" style="color:white">Keyword list</a></u></li>
     <li><u><a href="changelog210.html" style="color:white">Most recent changes</a></u></li>
     <li><u><a href="versions.html" style="color:white">Other versions</a></u></li>
     </span>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">An Overview of this Document</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Teasers</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="furtherexamples.html">Main Gallery</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="discontinuousgalerkin_nb.html">Discontinuous Galerkin Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="discontinuousgalerkin_nb.html#Advection-Diffusion:-Discontinuous-Galerkin-Method-with-Upwinding">Advection-Diffusion: Discontinuous Galerkin Method with Upwinding</a></li>
<li class="toctree-l3"><a class="reference internal" href="discontinuousgalerkin_nb.html#A-linear-transport-problem">A linear transport problem</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="elasticity_nb.html">Linear Elasticity: a deformed beam</a></li>
<li class="toctree-l2"><a class="reference internal" href="spiral_nb.html">Time Dependent Reaction Diffuison: spiral wave</a></li>
<li class="toctree-l2"><a class="reference internal" href="wave_nb.html">Wave Equation: double slit domain (using mass lumping)</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="stokes.html">Saddle point solver for the stationary Stokes problem</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Monolithic solver (Lagrange and DG formulation)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Taylor-Hood-formulation">Taylor-Hood formulation</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#Bercovier-Engelmann-Testcase">Bercovier-Engelmann Testcase</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#DG-formulation">DG formulation</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id3">Bercovier-Engelmann Testcase</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#Convergence-rate-check">Convergence rate check</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="fieldsplitStokes_nb.html">Stokes problem with fieldsplit preconditioner (PETSc)</a></li>
<li class="toctree-l3"><a class="reference internal" href="uzawa-scipy_nb.html">(Quasi) Stokes equations (Scipy based Uzawa scheme)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cylinder_nb.html">Navier-Stokes: flow around a cylinder</a></li>
<li class="toctree-l2"><a class="reference internal" href="mixed_poisson_nb.html">Mixed method for the Poisson equation</a></li>
<li class="toctree-l2"><a class="reference internal" href="evalues_laplace_nb.html">Eigenvalue problems</a><ul>
<li class="toctree-l3"><a class="reference internal" href="evalues_laplace_nb.html#Eigenvalues-of-the-Neumann-Laplacian">Eigenvalues of the Neumann Laplacian</a></li>
<li class="toctree-l3"><a class="reference internal" href="evalues_laplace_nb.html#Dirichlet-Eigenvalue-problem">Dirichlet Eigenvalue problem</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="biharmonic_IPC0_nb.html">Biharmonic problem</a><ul>
<li class="toctree-l3"><a class="reference internal" href="biharmonic_IPC0_nb.html#Implementation">Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="biharmonic_IPC0_nb.html#Simply-supported-boundary-conditions">Simply supported boundary conditions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="crystal_nb.html">Adaptive phase field: crystal growth model</a></li>
<li class="toctree-l2"><a class="reference internal" href="mcf_nb.html">Moving surface grid: flow under mean curvature</a></li>
<li class="toctree-l2"><a class="reference internal" href="laplace-dwr_nb.html">Dual Weighted Reisdual Estimate</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="furtherexamples.html#extension-modules">Extension Modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="furtherexamples.html#discontinuous-galerkin-methods-with-dune-fem-dg">Discontinuous Galerkin Methods with DUNE-FEM-DG</a><ul>
<li class="toctree-l3"><a class="reference internal" href="euler_nb.html">Euler System of Gas Dynamics</a></li>
<li class="toctree-l3"><a class="reference internal" href="chemical_nb.html">An Advection-Diffusion-Reaction System: Chemical Reaction Problem</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="furtherexamples.html#virtual-element-methods-with-dune-vem">Virtual Element Methods with DUNE-VEM</a><ul>
<li class="toctree-l3"><a class="reference internal" href="vemdemo_nb.html">Elliptic Problems</a></li>
<li class="toctree-l3"><a class="reference internal" href="vemdemo_nb.html#Nonlinear-Elliptic-Problem">Nonlinear Elliptic Problem</a></li>
<li class="toctree-l3"><a class="reference internal" href="vemdemo_nb.html#Linear-Elasticity">Linear Elasticity</a></li>
<li class="toctree-l3"><a class="reference internal" href="vemdemo_nb.html#Fourth-order-problem">Fourth order problem</a></li>
<li class="toctree-l3"><a class="reference internal" href="chimpl_nb.html">Cahn-Hilliard</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">From PyPi</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#additional-external-packages">Additional external packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#testing-the-installation">Testing the installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#hints-for-windows">Hints for Windows</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="installation.html#from-source">From Source</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#building-the-required-dune-modules">Building the Required Dune Modules</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="installation.html#troubleshooting">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="dune-fempy_nb.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="dune-fempy_nb.html#A-Laplace-problem">A Laplace problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="dune-fempy_nb.html#Laplace-equation-with-Dirichlet-boundary-conditions">Laplace equation with Dirichlet boundary conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="dune-fempy_nb.html#A-non-linear-elliptic-problem">A non-linear elliptic problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="dune-fempy_nb.html#Using-Constant-parameters-and-grid-functions-in-PDEs">Using <code class="docutils literal notranslate"><span class="pre">Constant</span></code> parameters and grid functions in PDEs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="concepts_nb.html">General Concepts (with a time dependent problem)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="concepts_nb.html#Setting-up-the-Grid">Setting up the Grid</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts_nb.html#Grid-Functions">Grid Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts_nb.html#Discrete-Spaces">Discrete Spaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts_nb.html#Discrete-Functions">Discrete Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts_nb.html#Operators-and-Schemes">Operators and Schemes</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts_nb.html#A-Nonlinear-Time-Dependent-Problem">A Nonlinear Time Dependent Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts_nb.html#Listing-Available-Dune-Components">Listing Available Dune Components</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Next Steps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="boundary_nb.html">More General Boundary Conditions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="boundary_nb.html#Dirichlet-boundary-conditions">Dirichlet boundary conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="boundary_nb.html#Accessing-the-Dirichlet-degrees-of-freedom">Accessing the Dirichlet degrees of freedom</a></li>
<li class="toctree-l2"><a class="reference internal" href="boundary_nb.html#Neumann-and-Robin-boundary-conditions">Neumann and Robin boundary conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="boundary_nb.html#Using-boundary-ids-(and-some-more-complex-examples)">Using boundary ids (and some more complex examples)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="boundary_nb.html#Cartesian-boundary-ids">Cartesian boundary ids</a></li>
<li class="toctree-l3"><a class="reference internal" href="boundary_nb.html#Mixing-different-types-of-boundary-conditions">Mixing different types of boundary conditions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="solversInternal_nb.html">Tweaking the (non-) linear solvers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="solversInternal_nb.html#Python-sided-Newton-solver">Python sided Newton solver</a></li>
<li class="toctree-l2"><a class="reference internal" href="solversInternal_nb.html#Handling-Dirichlet-boundary-conditions">Handling Dirichlet boundary conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="solversInternal_nb.html#Other-internal-solvers-(petsc)">Other internal solvers (petsc)</a></li>
<li class="toctree-l2"><a class="reference internal" href="solversInternal_nb.html#Other-internal-solvers-(istl)">Other internal solvers (istl)</a></li>
<li class="toctree-l2"><a class="reference internal" href="solversInternal_nb.html#Parameters-for-fine-tuning-the-internal-solvers">Parameters for fine-tuning the internal solvers</a></li>
<li class="toctree-l2"><a class="reference internal" href="solversInternal_nb.html#Available-solvers-and-parameters">Available solvers and parameters</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="solversExternal_nb.html">Alternative Solvers (e.g. Scipy, Petsc)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="solversExternal_nb.html#Accessing-underlying-data-structures">Accessing underlying data structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="solversExternal_nb.html#Defining-discrete-function-with-given-external-dof-vector">Defining discrete function with given external dof vector</a></li>
<li class="toctree-l2"><a class="reference internal" href="solversExternal_nb.html#Using-Scipy">Using Scipy</a></li>
<li class="toctree-l2"><a class="reference internal" href="solversExternal_nb.html#Using-scikit-umfpack">Using scikit-umfpack</a></li>
<li class="toctree-l2"><a class="reference internal" href="solversExternal_nb.html#Using-PETSc4Py">Using PETSc4Py</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="othergrids_nb.html">Examples of grid construction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="othergrids_nb.html#Example-using-the-Dune-Grid-Format-(DGF)">Example using the Dune Grid Format (DGF)</a></li>
<li class="toctree-l2"><a class="reference internal" href="othergrids_nb.html#3D-example-(using-PyGmsh)">3D example (using PyGmsh)</a></li>
<li class="toctree-l2"><a class="reference internal" href="othergrids_nb.html#Converting-gmsh-to-DGF">Converting gmsh to DGF</a><ul>
<li class="toctree-l3"><a class="reference internal" href="othergrids_nb.html#Attaching-boundary-ids-to-a-grid-constructed-with-gmsh-using-DGF">Attaching boundary ids to a grid constructed with gmsh using DGF</a></li>
<li class="toctree-l3"><a class="reference internal" href="othergrids_nb.html#Visualizing-Boundary-Ids">Visualizing Boundary Ids</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="othergrids_nb.html#Using-meshio-to-read-a-gmsh-file">Using <code class="docutils literal notranslate"><span class="pre">meshio</span></code> to read a gmsh file</a></li>
<li class="toctree-l2"><a class="reference internal" href="othergrids_nb.html#1D-example">1D example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="parallelization_nb.html">Parallelization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="parallelization_nb.html#OpenMP">OpenMP</a></li>
<li class="toctree-l2"><a class="reference internal" href="parallelization_nb.html#MPI">MPI</a><ul>
<li class="toctree-l3"><a class="reference internal" href="parallelization_nb.html#Load-balancing">Load balancing</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="backuprestore_nb.html">Backup and restore (pickling)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="backuprestore_nb.html#Pickling">Pickling</a></li>
<li class="toctree-l2"><a class="reference internal" href="backuprestore_nb.html#A-Chekpointer-class">A Chekpointer class</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="corepy.html">Using the Full Grid Interface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="dune-corepy_nb.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="dune-corepy_nb.html#Dense-Vectors-and-the-Geometry-Classes">Dense Vectors and the Geometry Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="dune-corepy_nb.html#Grid-Construction-and-Basic-Interface">Grid Construction and Basic Interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="dune-corepy_nb.html#Structured-grids">Structured grids</a></li>
<li class="toctree-l3"><a class="reference internal" href="dune-corepy_nb.html#Unstructured-grids">Unstructured grids</a></li>
<li class="toctree-l3"><a class="reference internal" href="dune-corepy_nb.html#Local-grid-adaptivity">Local grid adaptivity</a><ul>
<li class="toctree-l4"><a class="reference internal" href="dune-corepy_nb.html#Basic-information-and-iterators">Basic information and iterators</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="dune-corepy_nb.html#Using-grid-functions">Using grid functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="dune-corepy_nb.html#Importing-user-defined-C++-code">Importing user defined C++ code</a></li>
<li class="toctree-l2"><a class="reference internal" href="dune-corepy_nb.html#Attaching-Data-to-the-Grid">Attaching Data to the Grid</a></li>
<li class="toctree-l2"><a class="reference internal" href="dune-corepy_nb.html#Output-of-Grid-and-Visualization-of-Data">Output of Grid and Visualization of Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="dune-corepy_nb.html#Matplotlib">Matplotlib</a></li>
<li class="toctree-l3"><a class="reference internal" href="dune-corepy_nb.html#Paraview-(vtu/vtk-files)">Paraview (vtu/vtk files)</a></li>
<li class="toctree-l3"><a class="reference internal" href="dune-corepy_nb.html#Mayavi">Mayavi</a></li>
<li class="toctree-l3"><a class="reference internal" href="dune-corepy_nb.html#Low-level-output">Low level output</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Further Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="gridviews_and_adaptivity.html">Grid views and adaptivity</a><ul>
<li class="toctree-l2"><a class="reference internal" href="gridviews_and_adaptivity.html#overview-and-some-basic-grid-views-level-and-filtered">Overview and some basic grid views (level and filtered)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="levelgridview_nb.html">LevelGridView examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="filteredgridview_nb.html">FilteredGridView examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="gridviews_and_adaptivity.html#dynamic-local-grid-refinement-and-coarsening">Dynamic Local Grid Refinement and Coarsening</a><ul>
<li class="toctree-l3"><a class="reference internal" href="laplace-adaptive_nb.html">Re-entrant Corner Problem</a></li>
<li class="toctree-l3"><a class="reference internal" href="crystal_nb.html">Adaptive phase field: crystal growth model</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="gridviews_and_adaptivity.html#overview-on-adaptivity-for-spaces-p-adaptation">Overview on adaptivity for spaces (p-adaptation)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="twophaseflow_descr.html">HP adaptive DG scheme for twophase flow problem</a><ul>
<li class="toctree-l4"><a class="reference internal" href="twophaseflow_nb.html">Problem Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="twophaseflow_nb.html#Defining-the-model">Defining the model</a></li>
<li class="toctree-l4"><a class="reference internal" href="twophaseflow_nb.html#Time-discretization">Time discretization</a></li>
<li class="toctree-l4"><a class="reference internal" href="twophaseflow_nb.html#Stabilization-(Limiter)">Stabilization (Limiter)</a></li>
<li class="toctree-l4"><a class="reference internal" href="twophaseflow_nb.html#Iterative-schemes-(iterative-or-impes-iterative)">Iterative schemes (iterative or impes-iterative)</a></li>
<li class="toctree-l4"><a class="reference internal" href="twophaseflow_nb.html#HP-Adpativity">HP Adpativity</a></li>
<li class="toctree-l4"><a class="reference internal" href="twophaseflow_nb.html#Marker-for-grid-adaptivity-(h).">Marker for grid adaptivity (h).</a></li>
<li class="toctree-l4"><a class="reference internal" href="twophaseflow_nb.html#Marker-for-space-adaptivity-(p)">Marker for space adaptivity (p)</a></li>
<li class="toctree-l4"><a class="reference internal" href="twophaseflow_nb.html#Main-program">Main program</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="gridviews_and_adaptivity.html#evolving-domains">Evolving Domains</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mcf_nb.html">Moving surface grid: flow under mean curvature</a></li>
<li class="toctree-l3"><a class="reference internal" href="elasticity_nb.html">Linear Elasticity: a deformed beam</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cpp.html">Using C++ Code Snippets</a><ul>
<li class="toctree-l2"><a class="reference internal" href="cppfunctions_nb.html">C++ Based Grid Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="lineplot_nb.html">Sampling the Solution over a Line</a></li>
<li class="toctree-l2"><a class="reference internal" href="mcf-algorithm_nb.html">Mean Curvature Flow (revisited)</a></li>
<li class="toctree-l2"><a class="reference internal" href="laplace-dwr-algorithm_nb.html">Dual Weighted Reisdual Estimate (revisited)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="scheme_api.html">API for schemes and operators</a><ul>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#abstract-concepts">Abstract concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#operator-without-dbc">Operator without DBC:</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#operator-with-dbc">Operator with DBC:</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#scheme-without-dbc">Scheme without DBC:</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#scheme-with-dbc">Scheme with DBC:</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#additional">Additional</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#unclear">Unclear</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Projects using Dune-Fem</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="twophaseflow_descr.html">HP adaptive DG scheme for twophase flow problem</a><ul>
<li class="toctree-l2"><a class="reference internal" href="twophaseflow_nb.html">Problem Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="twophaseflow_nb.html#Defining-the-model">Defining the model</a></li>
<li class="toctree-l2"><a class="reference internal" href="twophaseflow_nb.html#Time-discretization">Time discretization</a></li>
<li class="toctree-l2"><a class="reference internal" href="twophaseflow_nb.html#Stabilization-(Limiter)">Stabilization (Limiter)</a></li>
<li class="toctree-l2"><a class="reference internal" href="twophaseflow_nb.html#Iterative-schemes-(iterative-or-impes-iterative)">Iterative schemes (iterative or impes-iterative)</a></li>
<li class="toctree-l2"><a class="reference internal" href="twophaseflow_nb.html#HP-Adpativity">HP Adpativity</a></li>
<li class="toctree-l2"><a class="reference internal" href="twophaseflow_nb.html#Marker-for-grid-adaptivity-(h).">Marker for grid adaptivity (h).</a></li>
<li class="toctree-l2"><a class="reference internal" href="twophaseflow_nb.html#Marker-for-space-adaptivity-(p)">Marker for space adaptivity (p)</a></li>
<li class="toctree-l2"><a class="reference internal" href="twophaseflow_nb.html#Main-program">Main program</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="mmesh_descr.html">Mixed-dimensional PDEs: the Dune-MMesh module</a><ul>
<li class="toctree-l2"><a class="reference internal" href="mmesh_nb.html">Dune-MMesh: Solving a Mixed-dimensional PDE</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="landlab_descr.html">Components for the Landlab software package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="overview_of_advection_solver_nb.html">Linear Advection</a><ul>
<li class="toctree-l3"><a class="reference internal" href="overview_of_advection_solver_nb.html#Advection-of-a-Gaussian-%22bump%22-in-2d">Advection of a Gaussian “bump” in 2d</a><ul>
<li class="toctree-l4"><a class="reference internal" href="overview_of_advection_solver_nb.html#Raster-grid-with-advection-to-the-east">Raster grid with advection to the east</a><ul>
<li class="toctree-l5"><a class="reference internal" href="overview_of_advection_solver_nb.html#Instantiate-component">Instantiate component</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="overview_of_advection_solver_nb.html#Raster-grid-with-advection-to-the-north">Raster grid with advection to the north</a></li>
<li class="toctree-l4"><a class="reference internal" href="overview_of_advection_solver_nb.html#Raster-grid-with-advection-to-the-southwest">Raster grid with advection to the southwest</a></li>
<li class="toctree-l4"><a class="reference internal" href="overview_of_advection_solver_nb.html#Raster-grid-with-a-non-uniform-advection-field">Raster grid with a non-uniform advection field</a></li>
<li class="toctree-l4"><a class="reference internal" href="overview_of_advection_solver_nb.html#Case-of-divergent-velocity">Case of divergent velocity</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="overview_of_advection_solver_nb.html#A-rotating-cone">A rotating cone</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="linear_diffusion_overland_flow_dune_nb.html">A Linear Diffusion Overland Flow Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="linear_diffusion_overland_flow_dune_nb.html#Overview">Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="linear_diffusion_overland_flow_dune_nb.html#Model">Model</a><ul>
<li class="toctree-l5"><a class="reference internal" href="linear_diffusion_overland_flow_dune_nb.html#Flow-direction,-depth,-and-velocity">Flow direction, depth, and velocity</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="linear_diffusion_overland_flow_dune_nb.html#Numerical-Methods">Numerical Methods</a></li>
<li class="toctree-l4"><a class="reference internal" href="linear_diffusion_overland_flow_dune_nb.html#The-component">The component</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="linear_diffusion_overland_flow_dune_nb.html#Example-2:-overland-flow-on-a-DEM">Example 2: overland flow on a DEM</a></li>
<li class="toctree-l3"><a class="reference internal" href="linear_diffusion_overland_flow_dune_nb.html#References">References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ddfem_descr.html">DDFEM: Diffuse Domain Python package</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Information and Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="citing.html">Citing this project</a></li>
<li class="toctree-l1"><a class="reference internal" href="developers.html">Information for C++ Developers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="developers.html#remove-and-rebuild-existing-modules">Remove and rebuild existing modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="developers.html#using-a-debugger">Using a debugger</a></li>
<li class="toctree-l2"><a class="reference internal" href="developers.html#list-of-build-specific-environment-variables">List of build specific environment variables</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contributions.html">Contributing to this tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributions.html#how-to-showcase-your-own-work">How to showcase your own work</a></li>
<li class="toctree-l1"><a class="reference internal" href="additional.html">Additional Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="changelog290.html">Since 2.9 release</a><ul>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#general-changes">General changes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#updating-to-newer-version-of-ufl">Updating to newer version of UFL</a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#new-clone-method-on-spaces">New <cite>clone</cite> method on spaces</a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#dirichlet-bcs-for-operators-with-different-range-domain-space">Dirichlet BCs for operators with different range/domain space</a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#changes-to-solver-parameter-keys">Changes to solver parameter keys</a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#added-a-solve-method-to-the-linearization-of-schemes">Added a <code class="docutils literal notranslate"><span class="pre">solve</span></code> method to the linearization of <code class="docutils literal notranslate"><span class="pre">schemes</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#updated-dune-fem-scheme-linearized">Updated <code class="docutils literal notranslate"><span class="pre">dune.fem.scheme.linearized</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#add-operator-len-to-spaces">Add operator <code class="docutils literal notranslate"><span class="pre">__len__</span></code> to spaces.</a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#add-dirichletindices-method-to-operators-and-schemes">Add <code class="docutils literal notranslate"><span class="pre">DirichletIndices</span></code> method to operators and schemes</a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#extension-of-the-jacobian-method-on-schemes-and-operators">Extension of the <code class="docutils literal notranslate"><span class="pre">jacobian</span></code> method on schemes and operators</a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#set-non-default-quadratures-in-quadrature-rules">Set non default quadratures in quadrature rules</a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#assembly-function">Assembly function</a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#improved-pickling-support">Improved Pickling support</a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#paraview-reader">Paraview Reader</a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#sampler-along-boundary">Sampler along Boundary</a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#point-sampler-returning-entity-local-coordinate-for-given-global-coordinate">Point sampler returning (entity,local coordinate) for given global coordinate</a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#improved-boundary-indexing-in-ufl-forms-for-boundary-integrals-and-dirichlet-conditions">Improved Boundary Indexing in UFL Forms (for boundary integrals and Dirichlet conditions)</a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#eisenstatwalker-in-newton-method">Eisenstatwalker in Newton method</a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#storage-setup-in-scheme">Storage setup in scheme</a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#methods-on-space-to-return-local-mapper-and-for-evaluating-basis-functions">Methods on space to return local mapper and for evaluating basis functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#logging-of-parameter-values">Logging of parameter values</a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#deprecation-of-the-rhs-argument-for-scheme-solve">Deprecation of the <code class="docutils literal notranslate"><span class="pre">rhs</span></code> argument for <code class="docutils literal notranslate"><span class="pre">scheme.solve</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#deprecation-of-dune-fem-function-integrate">Deprecation of <code class="docutils literal notranslate"><span class="pre">dune.fem.function.integrate</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#deprecation-of-dune-fem-function-uflfunction-and-dune-fem-function-cppfunction">Deprecation of <code class="docutils literal notranslate"><span class="pre">dune.fem.function.uflFunction</span></code> and <code class="docutils literal notranslate"><span class="pre">dune.fem.function.cppFunction</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#deprecation-of-dune-ufl-expression2gf">Deprecation of <code class="docutils literal notranslate"><span class="pre">dune.ufl.expression2GF</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#deprecation-of-dune-fem-operator-linear">Deprecation of <code class="docutils literal notranslate"><span class="pre">dune.fem.operator.linear</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#deprecation-of-dune-fem-space-combinedspace">Deprecation of <code class="docutils literal notranslate"><span class="pre">dune.fem.space.combinedSpace</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="changelog290.html#dune-vem">DUNE-VEM</a><ul>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#dirichlet-constraints-for-conforming-c-1-space">Dirichlet constraints for conforming $C^1$ space</a></li>
<li class="toctree-l4"><a class="reference internal" href="changelog290.html#intersection-integrals-now-use-the-edge-projections">Intersection integrals now use the edge projections</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="changelog210.html">Since 2.10 release</a><ul>
<li class="toctree-l3"><a class="reference internal" href="changelog210.html#breaking-changes">Breaking changes</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog210.html#general-changes">General changes</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog210.html#bugfixes">Bugfixes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="changelog210.html#pickling-of-discrete-functions">Pickling of discrete functions</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="versions.html">DUNE-FEM Tutorial Versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="inforesources.html">Keyword index</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional pages</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="gmsh2dgf_nb.html">Converting gmsh to DGF</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurmbatchscript.html">Slurm batch script</a></li>
<li class="toctree-l1"><a class="reference internal" href="scheme_api.html">API for schemes and operators</a><ul>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#abstract-concepts">Abstract concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#operator-without-dbc">Operator without DBC:</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#operator-with-dbc">Operator with DBC:</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#scheme-without-dbc">Scheme without DBC:</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#scheme-with-dbc">Scheme with DBC:</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#additional">Additional</a></li>
<li class="toctree-l2"><a class="reference internal" href="scheme_api.html#unclear">Unclear</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="todo.html">List of things that need doing…</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">DUNE-FEM Tutorial</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="furtherexamples.html">Main Gallery</a></li>
          <li class="breadcrumb-item"><a href="stokes.html">Saddle point solver for the stationary Stokes problem</a></li>
      <li class="breadcrumb-item active">Monolithic solver (Lagrange and DG formulation)</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul><div class="rst-breadcrumbs-buttons" role="navigation" aria-label="Sequential page navigation">
        <a href="stokes.html" class="btn btn-neutral float-left" title="Saddle point solver for the stationary Stokes problem" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="fieldsplitStokes_nb.html" class="btn btn-neutral float-right" title="Stokes problem with fieldsplit preconditioner (PETSc)" accesskey="n">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="admonition note">
<p class="admonition-title">Note</p>
This document is part of the dune-fem tutorial
<a href="https://doi.org/10.5281/zenodo.3706994"><img src="https://zenodo.org/badge/DOI/10.5281/zenodo.3706994.svg" alt="DOI"></a><div class="line-block">
<div class="line">Download <em>monolithicStokes</em> as <a class="reference download internal" download="" href="_downloads/c3bda2dfe0906564f00af8060fbec660/monolithicStokes_nb.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Jupyter</span> <span class="pre">notebook</span> <span class="pre">(_nb.ipynb)</span></code></a> or as <a class="reference download internal" download="" href="_downloads/3c3f7a2fa3a6b47c7f401c2620f37eb1/monolithicStokes.py"><code class="xref download docutils literal notranslate"><span class="pre">Python</span> <span class="pre">script</span> <span class="pre">(.py)</span></code></a></div>
</div>
</div>
<section id="Monolithic-solver-(Lagrange-and-DG-formulation)">
<h1>Monolithic solver (Lagrange and DG formulation)<a class="headerlink" href="#Monolithic-solver-(Lagrange-and-DG-formulation)" title="Link to this heading"></a></h1>
<p id="index-3"><span id="index-2"></span><span id="index-1"></span><span id="index-0"></span><em>Section author: contribution by Benjamin Terschanski</em></p>
<p>This example shows how to work with composite spaces of different polynomial order to construct LBB stable pairs for velocity and pressure approximations.</p>
<p>Consider the stationary stokes problem with Newtonian stress on a unit square <span class="math notranslate nohighlight">\(\Omega = [0,\,1]^2\)</span>. Governing Equations are</p>
<p><span class="math">\begin{align}
-\mu\nabla^2\mathbf{u} + \nabla p &= \mathbf{f} \qquad \text{Conservation of Momentum} \\
-\nabla \cdot \mathbf{u} &= 0 \qquad \text{Conservation of Mass} \\
\end{align}</span></p>
<p>The problem is closed with Dirichlet boundary conditions</p>
<div class="math notranslate nohighlight">
\[u = u_D \quad \text{on} \partial\Omega\]</div>
<p>where <span class="math notranslate nohighlight">\(u_D = u_D(x,y)\)</span> will be taken from the analytical solution of the testcase defined later. Please note that the weak forms defined here assume Dirichlet velocity boundary conditions on the entire domain boundary <span class="math notranslate nohighlight">\(\partial \Omega\)</span> and we thus avoid having to distinguish between Dirichlet and non-Dirichlet parts of the exterior boundary <code class="docutils literal notranslate"><span class="pre">ds</span></code>.</p>
<p>We first introduce a discrete domain <span class="math notranslate nohighlight">\(\Omega_h\)</span> with a structured quadrilateral grid:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dune.grid</span><span class="w"> </span><span class="kn">import</span> <span class="n">structuredGrid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dune.ufl</span><span class="w"> </span><span class="kn">import</span> <span class="n">cell</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufl</span><span class="w"> </span><span class="kn">import</span> <span class="n">SpatialCoordinate</span><span class="p">,</span> <span class="n">FacetNormal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">gridView</span> <span class="o">=</span> <span class="n">structuredGrid</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
<span class="n">dim_space</span> <span class="o">=</span> <span class="n">gridView</span><span class="o">.</span><span class="n">dimGrid</span>

<span class="n">spatial_coordinate</span> <span class="o">=</span> <span class="n">SpatialCoordinate</span><span class="p">(</span><span class="n">cell</span><span class="p">(</span><span class="n">dim_space</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>A weak form of stationary stokes problem reads</p>
<div class="math notranslate nohighlight">
\[\mu\int_{\Omega_h} \nabla\mathbf{u_h}:\nabla\mathbf{v_h}\,\mathrm{d}x - \underline{\int_{\partial\Omega_h} (\nabla\mathbf{u_h}\cdot \mathbf{n})\cdot\mathbf{v}_h \, \mathrm{d}s} - \int_{\Omega_h} p_h\,\nabla\cdot\mathbf{v_h} \,\mathrm{d}x + \underline{\int_{\partial\Omega_h} p_h\,\mathbf{v}_h\cdot\mathbf{n}\, \mathrm{d}s} = \int_\Omega \mathbf{f}\cdot\mathbf{v}_h\,\mathrm{d}x\]</div>
<div class="math notranslate nohighlight">
\[\int_{\Omega_h} \nabla\cdot\mathbf{u_h}\, q_h\,\mathrm{d}x = 0\]</div>
<p>where the underlined terms vanish if <span class="math notranslate nohighlight">\(\mathbf{v_h} \in H_0^1(\Omega_h)\)</span>. Here, <span class="math notranslate nohighlight">\(\mathbf{u_h}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{v_h}\)</span> <span class="math notranslate nohighlight">\(\in V_h\)</span> denote vector-valued (in our case 2D) trial- and test-functions for the velocity, <span class="math notranslate nohighlight">\(p_h\)</span> and <span class="math notranslate nohighlight">\(q_h\)</span> <span class="math notranslate nohighlight">\(\in Q_h\)</span> denote trial- and test-function for the pressure. In this example we will chose <span class="math notranslate nohighlight">\(V_h\)</span> and <span class="math notranslate nohighlight">\(Q_h\)</span> as polynomial spaces of order <span class="math notranslate nohighlight">\(P^k\)</span> and <span class="math notranslate nohighlight">\(P^{k-1}\)</span> for velocity and pressure respectively (“Taylor-Hood
Elements”). This combination is well-known for being LBB-stable / satisfying a discrete inf-sup condition for the problem at hand, which is a prerequisite to guarantee well-posedness of the primal form we are using.</p>
<p>On the DUNE side we start by initializing some geometric / ufl variables (some will only be needed later on for the DG version of our approximation).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ufl</span><span class="w"> </span><span class="kn">import</span> <span class="n">div</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">dot</span><span class="p">,</span> <span class="n">inner</span><span class="p">,</span> <span class="n">dS</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">jump</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="n">CellVolume</span><span class="p">,</span> <span class="n">FacetArea</span><span class="p">,</span> <span class="n">MinCellEdgeLength</span><span class="p">,</span> <span class="n">MinFacetEdgeLength</span><span class="p">,</span> <span class="n">conditional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dune.ufl</span><span class="w"> </span><span class="kn">import</span> <span class="n">Constant</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Surface normal on the exterior boundary</span>
<span class="n">n</span>  <span class="o">=</span> <span class="n">FacetNormal</span><span class="p">(</span><span class="n">cell</span><span class="p">(</span><span class="n">dim_space</span><span class="p">))</span>

<span class="c1"># each element facet has sides + | - with normal ne=n(&#39;+&#39;) pointing</span>
<span class="c1"># from + to - ( meaning + |-&gt; -)</span>
<span class="c1"># in the notation of the paper: superscript &quot;int&quot; == (&#39;+&#39;), &quot;ext&quot; == (&#39;-&#39;)</span>
<span class="c1"># see (BDK12) for more details</span>
<span class="n">ne</span> <span class="o">=</span> <span class="n">n</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>

<span class="c1"># Representative element length for interior facets</span>
<span class="n">h_int</span> <span class="o">=</span> <span class="n">avg</span><span class="p">(</span><span class="n">CellVolume</span><span class="p">(</span><span class="n">cell</span><span class="p">(</span><span class="n">dim_space</span><span class="p">)))</span> <span class="o">/</span> <span class="n">FacetArea</span><span class="p">(</span><span class="n">cell</span><span class="p">(</span><span class="n">dim_space</span><span class="p">))</span>

<span class="c1"># Representative element length for exterior facets (boundaries)</span>
<span class="n">h_ext</span> <span class="o">=</span> <span class="n">CellVolume</span><span class="p">(</span><span class="n">cell</span><span class="p">(</span><span class="n">dim_space</span><span class="p">))</span> <span class="o">/</span> <span class="n">FacetArea</span><span class="p">(</span><span class="n">cell</span><span class="p">(</span><span class="n">dim_space</span><span class="p">))</span>

<span class="c1"># Penalization of discontinuities / boundary value</span>
<span class="n">sigma_ip</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;interior_penalty_parameter&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="Taylor-Hood-formulation">
<h2>Taylor-Hood formulation<a class="headerlink" href="#Taylor-Hood-formulation" title="Link to this heading"></a></h2>
<p>We now define the weak form of the stokes problem, first in a standard Continuous Galerkin (CG) setting:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">weak_form_stationary_stokes</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span> <span class="n">dirichlet_velocity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return weak form for the stationary stokes problem, given a set of trial and test basis</span>
<span class="sd">    functions for velocity and pressure.</span>

<span class="sd">    This weak form corresponds to the canonical saddle point problem.</span>

<span class="sd">    :param u: (vector-valued) trial function for velocity (in R^d)</span>
<span class="sd">    :param v: (vector-valued) test function for velocity (in R^d)</span>
<span class="sd">    :param p: (scalar) trial function for pressure (in R)</span>
<span class="sd">    :param q: (scalar) test function for pressure (in R)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Note: This assumes Dirichlet Velocity BCs everywhere so we don&#39;t need</span>
    <span class="c1"># the boundary integrals which are shown here for completeness</span>
    <span class="n">viscous_stress</span> <span class="o">=</span> <span class="n">mu</span><span class="o">*</span><span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">*</span><span class="n">dx</span> <span class="c1"># - inner(dot(grad(u),n), v)*ds</span>

    <span class="n">pressure_force</span> <span class="o">=</span> <span class="o">-</span><span class="n">p</span><span class="o">*</span><span class="n">div</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span> <span class="c1"># + p*dot(v,n)*ds</span>
    <span class="n">continuity</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">dx</span>

    <span class="n">lhs_terms</span> <span class="o">=</span> <span class="n">viscous_stress</span> <span class="o">+</span> <span class="n">pressure_force</span> <span class="o">+</span> <span class="n">continuity</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dirichlet_velocity</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        `dirichlet_velocity` input argument can be used to enforce</span>
<span class="sd">        velocity Dirichlet BCs weakly (e.g. by penalizing deviations of u</span>
<span class="sd">        from `dirichlet_velocty` on the boundary, &quot;Nietzsche&#39;s Method&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nietzsche_terms</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigma_ip</span><span class="o">/</span><span class="n">h_ext</span><span class="p">)</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="o">-</span><span class="n">dirichlet_velocity</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">ds</span>
        <span class="n">lhs_terms</span> <span class="o">+=</span> <span class="n">nietzsche_terms</span>


    <span class="k">return</span> <span class="n">lhs_terms</span> <span class="o">==</span> <span class="n">dot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
</pre></div>
</div>
</div>
<section id="Bercovier-Engelmann-Testcase">
<h3>Bercovier-Engelmann Testcase<a class="headerlink" href="#Bercovier-Engelmann-Testcase" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://numtourcfd.pages.math.cnrs.fr/doc/NumtourCFD/v1.0.1-alpha.2/applications/validation/bercovier-engelman.html">Reference case with analytical solution</a> which was originally published in <span id="id1">[<a class="reference internal" href="index.html#id25" title="Michel Bercovier and Michael Engelman. A finite element for the numerical solution of viscous incompressible flows. Journal of Computational Physics, 30(2):181-201, 1979. doi:10.1016/0021-9991(79)90098-6.">BE79</a>]</span>. Equations for <span class="math notranslate nohighlight">\(f\)</span> are taken from the benchmark document <span id="id2">[<a class="reference internal" href="index.html#id26" title="P.-E. Angeli, M.-A. Puscas, G. Fauchet, and A. Cartalade. FVCA8 Benchmark for the Stokes and Navier–Stokes Equations with the TrioCFD Code—Benchmark Session. In Clément Cancès and Pascal Omnes, editors, Finite Volumes for Complex Applications VIII - Methods and Theoretical Aspects, 181–202. Springer, 2017. doi:10.1007/978-3-319-57397-7_12.">APFC17</a>]</span>:</p>
<div class="math notranslate nohighlight">
\[\Omega = [0,\,1]^2\]</div>
<p>With <span class="math notranslate nohighlight">\(\mu\equiv 1\)</span> the problem has the analytical solution <span class="math">\begin{align*}
u(x,y) &= -256\,y\,(y-1)\,(2\,y -1)\,x^2\,(x-1)^2 \\
v(x,y) &= 256\,x\,(x-1)\,(2\,x-1)\,y^2\,(y-1)^2 \\
p &= (x-0.5)\,(y-0.5) \\
\mathbf{f} &= (f_1(x,\,y) + (y-0.5), -f_1(y,\,x) + (x-0.5))^T
\end{align*}</span> where <span class="math notranslate nohighlight">\(f_1(x,\,y) = 256\,[x^2\,(x-1)^2\,(12\,y-6) + y\,(y-1)\,(2\,y-1)(12\,x^2 -12\,x + 2) ]\)</span></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dune.ufl</span><span class="w"> </span><span class="kn">import</span> <span class="n">DirichletBC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufl</span><span class="w"> </span><span class="kn">import</span> <span class="n">as_vector</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dune.fem.function</span><span class="w"> </span><span class="kn">import</span> <span class="n">gridFunction</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">spatial_coordinate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">spatial_coordinate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">u_exact</span> <span class="o">=</span> <span class="n">gridFunction</span><span class="p">(</span><span class="o">-</span><span class="mi">256</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                      <span class="n">gridView</span><span class="p">,</span>
                      <span class="n">name</span><span class="o">=</span><span class="s2">&quot;analytical_solution_x&quot;</span><span class="p">,</span>
                      <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">v_exact</span> <span class="o">=</span> <span class="n">gridFunction</span><span class="p">(</span><span class="mi">256</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                      <span class="n">gridView</span><span class="p">,</span>
                      <span class="n">name</span><span class="o">=</span><span class="s2">&quot;analytical_solution_y&quot;</span><span class="p">,</span>
                      <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">p_exact</span> <span class="o">=</span> <span class="n">gridFunction</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="mf">0.5</span><span class="p">),</span>
                      <span class="n">gridView</span><span class="p">,</span>
                      <span class="n">name</span><span class="o">=</span><span class="s2">&quot;analytical_solution_pressure&quot;</span><span class="p">,</span>
                      <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">f_1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">256</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">12</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">12</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span><span class="mi">12</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">f_exact</span> <span class="o">=</span> <span class="n">gridFunction</span><span class="p">(</span><span class="n">as_vector</span><span class="p">([</span><span class="n">f_1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="mf">0.5</span><span class="p">),</span> <span class="o">-</span><span class="n">f_1</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)]),</span>
                      <span class="n">gridView</span><span class="p">,</span>
                      <span class="n">name</span><span class="o">=</span><span class="s2">&quot;analytical_solution_force_term&quot;</span><span class="p">,</span>
                      <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">mu</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<p>Continuous Galerkin (CG) setup</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------------&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Set up composite space and scheme in CG setting: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dune.fem.space</span><span class="w"> </span><span class="kn">import</span> <span class="n">lagrange</span><span class="p">,</span> <span class="n">composite</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufl</span><span class="w"> </span><span class="kn">import</span> <span class="n">TrialFunction</span><span class="p">,</span> <span class="n">TestFunction</span><span class="p">,</span> <span class="n">as_vector</span><span class="p">,</span> <span class="n">eq</span><span class="p">,</span> <span class="n">conditional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dune.fem.scheme</span><span class="w"> </span><span class="kn">import</span> <span class="n">galerkin</span> <span class="k">as</span> <span class="n">solutionScheme</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dune.ufl</span><span class="w"> </span><span class="kn">import</span> <span class="n">BoundaryId</span>

<span class="n">velocity_order</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">space_velocity</span> <span class="o">=</span> <span class="n">lagrange</span><span class="p">(</span><span class="n">gridView</span><span class="p">,</span>
                          <span class="n">dimRange</span><span class="o">=</span><span class="n">dim_space</span><span class="p">,</span>
                          <span class="n">order</span><span class="o">=</span><span class="n">velocity_order</span><span class="p">,</span>
                          <span class="n">storage</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>

<span class="n">space_pressure</span> <span class="o">=</span> <span class="n">lagrange</span><span class="p">(</span><span class="n">gridView</span><span class="p">,</span>
                          <span class="n">dimRange</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">order</span><span class="o">=</span><span class="n">velocity_order</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">storage</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>

<span class="n">taylor_hood_space</span> <span class="o">=</span> <span class="n">composite</span><span class="p">(</span><span class="n">space_velocity</span><span class="p">,</span> <span class="n">space_pressure</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;velocity&quot;</span><span class="p">,</span> <span class="s2">&quot;pressure&quot;</span><span class="p">])</span>

<span class="n">U</span>     <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="n">taylor_hood_space</span><span class="p">)</span>
<span class="n">V</span>     <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="n">taylor_hood_space</span><span class="p">)</span>

<span class="n">u_h</span> <span class="o">=</span> <span class="n">as_vector</span><span class="p">([</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">v_h</span> <span class="o">=</span> <span class="n">as_vector</span><span class="p">([</span><span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">p_h</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">q_h</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="n">is_left</span>  <span class="o">=</span> <span class="n">eq</span><span class="p">(</span><span class="n">BoundaryId</span><span class="p">(</span><span class="n">taylor_hood_space</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
<span class="n">is_right</span> <span class="o">=</span> <span class="n">eq</span><span class="p">(</span><span class="n">BoundaryId</span><span class="p">(</span><span class="n">taylor_hood_space</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
<span class="n">is_bot</span>   <span class="o">=</span> <span class="n">eq</span><span class="p">(</span><span class="n">BoundaryId</span><span class="p">(</span><span class="n">taylor_hood_space</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
<span class="n">is_top</span>   <span class="o">=</span> <span class="n">eq</span><span class="p">(</span><span class="n">BoundaryId</span><span class="p">(</span><span class="n">taylor_hood_space</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span>

<span class="n">dirichlet_bcs_exact</span>   <span class="o">=</span> <span class="p">[</span><span class="n">DirichletBC</span><span class="p">(</span><span class="n">taylor_hood_space</span><span class="p">,</span> <span class="p">[</span><span class="n">u_exact</span><span class="p">,</span> <span class="n">v_exact</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">is_left</span><span class="p">),</span>
                         <span class="n">DirichletBC</span><span class="p">(</span><span class="n">taylor_hood_space</span><span class="p">,</span> <span class="p">[</span><span class="n">u_exact</span><span class="p">,</span> <span class="n">v_exact</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">is_right</span><span class="p">),</span>
                         <span class="n">DirichletBC</span><span class="p">(</span><span class="n">taylor_hood_space</span><span class="p">,</span> <span class="p">[</span><span class="n">u_exact</span><span class="p">,</span> <span class="n">v_exact</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">is_bot</span><span class="p">),</span>
                         <span class="n">DirichletBC</span><span class="p">(</span><span class="n">taylor_hood_space</span><span class="p">,</span> <span class="p">[</span><span class="n">u_exact</span><span class="p">,</span> <span class="n">v_exact</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">is_top</span><span class="p">)]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;velocity element order: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">taylor_hood_space</span><span class="o">.</span><span class="n">subSpaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">order</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pressure element order: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">taylor_hood_space</span><span class="o">.</span><span class="n">subSpaces</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">order</span><span class="p">))</span>

<span class="n">solution_vector_cg</span> <span class="o">=</span> <span class="n">taylor_hood_space</span><span class="o">.</span><span class="n">interpolate</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">dim_space</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;solution_vector_cg&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;solution_vector.order = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">solution_vector_cg</span><span class="o">.</span><span class="n">order</span><span class="p">))</span>

<span class="n">solver_parameters</span> <span class="o">=</span><span class="p">{</span><span class="s2">&quot;nonlinear.tolerance&quot;</span><span class="p">:</span> <span class="mf">1e-10</span><span class="p">,</span>
                    <span class="s2">&quot;nonlinear.verbose&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;linear.tolerance&quot;</span><span class="p">:</span> <span class="mf">1e-14</span><span class="p">,</span>
                    <span class="s2">&quot;linear.preconditioning.method&quot;</span><span class="p">:</span> <span class="s2">&quot;ilu&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;linear.verbose&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;linear.maxiterations&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}</span>

<span class="c1"># Alternative (commented) version uses weakly imposed boundary conditions:</span>
<span class="c1"># eqns = weak_form_stationary_stokes(u_h, v_h, p_h, q_h, f_exact, mu, as_vector([u_exact, v_exact]))</span>

<span class="n">eqns</span> <span class="o">=</span>  <span class="p">[</span><span class="n">weak_form_stationary_stokes</span><span class="p">(</span><span class="n">u_h</span><span class="p">,</span> <span class="n">v_h</span><span class="p">,</span> <span class="n">p_h</span><span class="p">,</span> <span class="n">q_h</span><span class="p">,</span> <span class="n">f_exact</span><span class="p">,</span> <span class="n">mu</span><span class="p">),</span> <span class="o">*</span><span class="n">dirichlet_bcs_exact</span><span class="p">]</span>
<span class="n">scheme_taylor_hood_cg</span> <span class="o">=</span> <span class="n">solutionScheme</span><span class="p">(</span><span class="n">eqns</span><span class="p">,</span>
                                       <span class="n">space</span><span class="o">=</span><span class="n">taylor_hood_space</span><span class="p">,</span>
                                       <span class="n">parameters</span><span class="o">=</span><span class="n">solver_parameters</span><span class="p">,</span>
                                       <span class="n">solver</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;istl&quot;</span><span class="p">,</span> <span class="s2">&quot;bicgstab&quot;</span><span class="p">))</span>
<br/><br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


----------------------
Set up composite space and scheme in CG setting:

velocity element order: 3
pressure element order: 2
solution_vector.order = 3
</pre></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Linear solvers and preconditioning</strong>: The matrix arising from the stokes discretization with mixed fem is indefinite and solving the linear system with iterative solvers can become challenging (to impossible) without proper preconditioning. For this toy problem, a combination of incomplete LU preconditioning and <code class="docutils literal notranslate"><span class="pre">bicgstab</span></code> works well. Other options include direct solvers or using Schur-complement preconditioners, due to the block structure of the Stokes matrix</p>
</div>
<p>Test solve with CG on the toy mesh:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------------&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test solve with continuous galerkin on the base mesh: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">sigma_ip</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">solution_vector_cg</span><span class="o">.</span><span class="n">interpolate</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">dim_space</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">scheme_taylor_hood_cg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">solution_vector_cg</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solve finished! </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number linear iterations: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;linear_iterations&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


----------------------
Test solve with continuous galerkin on the base mesh:

Solve finished!

number linear iterations: 13
</pre></div></div>
</div>
<p>Here is a plot of the pressure and velocity field:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">solution_vector_cg</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vectors</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">gridLines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
<span class="n">solution_vector_cg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">gridLines</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/monolithicStokes_nb_16_0.jpg" src="_images/monolithicStokes_nb_16_0.jpg" />
</div>
</div>
</section>
</section>
<section id="DG-formulation">
<h2>DG formulation<a class="headerlink" href="#DG-formulation" title="Link to this heading"></a></h2>
<p>In the DG framework the weak form becomes more complicated because we have to deal with a discontinuous basis. The discontinuities yield a bunch of jump terms on the inter-element boundaries (<em>interior facets</em>) that we have to approximate. A full coverage of the DG setup is beyond the scope of this tutorial, the references below can serve as starting point. TODO add reference</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Switch for interior penalty stabilization method</span>
<span class="c1"># -1: symmetric interior penalty (SIP)</span>
<span class="c1">#  1: non-symmetric &quot; &quot; (NIPG)</span>
<span class="c1">#  0: stabilization off</span>
<span class="n">method_switch_ip</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;switch_interior_penalty_method&quot;</span><span class="p">)</span>


<span class="n">gamma_grad_div</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;grad_div_stab_param&quot;</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Switch / penalty parameter for &quot;grad/div&quot;-type stabilization term,</span>
<span class="sd">adds an additional penalization of the discrete divergence</span>
<span class="sd">(gamma_grad_div*div(v_h)*div(u_h)*dx ) where u_h, v_h are trial-</span>
<span class="sd">and test-functions for velocity.</span>

<span class="sd">See also Eqn. (41) of</span>
<span class="sd">https://doi.org/10.48550/arXiv.1711.04442 for the definition</span>
<span class="sd">and further discussion.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">gamma_mass_flux</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mass_flux_stab_param&quot;</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Switch / penalty parameter for &quot;mass-flux&quot; stabilization, e.g.</span>
<span class="sd">a penalization of deviations of the velocity from the H1_div</span>
<span class="sd">space. More precisely, jumps in the normal component of the</span>
<span class="sd">discrete velocity are penalized, yielding a &quot;better&quot; element-local mass</span>
<span class="sd">conservation.</span>

<span class="sd">This could be intuitively thought of as</span>
<span class="sd">pushing the solution from a DG approximation space to behave like</span>
<span class="sd">a solution from a H_div conforming space (RT, ...).</span>
<span class="sd">Full discussion in https://doi.org/10.48550/arXiv.1711.04442 , see Eqn. (18)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="n">gamma_stab_cburn</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;stab_cburn&quot;</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Gamma from Eqn (19) for the stabilization term j0 defined in Eqn (18)</span>
<span class="sd">of https://doi.org/10.1016/j.cma.2018.07.019</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">c_h_cburn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Stabilization term from https://doi.org/10.1016/j.cma.2018.07.019 (Eqn. 19)&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">gamma_stab_cburn</span><span class="o">*</span><span class="n">h_int</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">jump</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">ne</span><span class="p">,</span> <span class="n">jump</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">ne</span><span class="p">)</span><span class="o">*</span><span class="n">dS</span>



<span class="k">def</span><span class="w"> </span><span class="nf">weak_form_stationary_stokes_dg</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span> <span class="n">is_dirichlet_velocity</span><span class="p">,</span> <span class="n">dirichlet_value_velocity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return weak form for the stationary stokes problem, given a set of trial and test basis</span>
<span class="sd">    functions for velocity and pressure. The viscous stress is discretized</span>
<span class="sd">    with SIPG.</span>

<span class="sd">    The exact DG form / fluxes correspond to the method documented in https://doi.org/10.48550/arXiv.1711.04442</span>
<span class="sd">    In particular, viscous_stress = a(u, v), pressure_force = b(v,p)</span>

<span class="sd">    :param u: (vector-valued) trial function for velocity (in R^d)</span>
<span class="sd">    :param v: (vector-valued) test function for velocity (in R^d)</span>
<span class="sd">    :param p: (scalar) trial function for pressure (in R)</span>
<span class="sd">    :param q: (scalar) test function for pressure (in R)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Interior penalty stabilization of viscous terms and penalization</span>
    <span class="c1"># of jump discontinuities (also used to weakly enforce Dirichlet BCs in the</span>
    <span class="c1"># last term)</span>

    <span class="n">viscous_stress</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">*</span><span class="n">dx</span> \
                   <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">))</span><span class="o">*</span><span class="n">ne</span><span class="p">,</span> <span class="n">jump</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">*</span><span class="n">dS</span> \
                   <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">is_dirichlet_velocity</span><span class="o">*</span><span class="n">ds</span> \
                   <span class="o">+</span> <span class="n">method_switch_ip</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">*</span><span class="n">ne</span><span class="p">,</span> <span class="n">jump</span><span class="p">(</span><span class="n">u</span><span class="p">))</span><span class="o">*</span><span class="n">dS</span> \
                   <span class="o">+</span> <span class="n">method_switch_ip</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">u</span>  <span class="o">-</span> <span class="n">dirichlet_value_velocity</span><span class="p">)</span><span class="o">*</span><span class="n">is_dirichlet_velocity</span><span class="o">*</span><span class="n">ds</span> \
                   <span class="o">+</span> <span class="p">(</span><span class="n">sigma_ip</span><span class="o">/</span><span class="n">h_int</span><span class="p">)</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">jump</span><span class="p">(</span><span class="n">u</span><span class="p">),</span><span class="n">jump</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">*</span><span class="n">dS</span> \
                   <span class="o">+</span> <span class="p">(</span><span class="n">sigma_ip</span><span class="o">/</span><span class="n">h_ext</span><span class="p">)</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">dirichlet_value_velocity</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">is_dirichlet_velocity</span><span class="o">*</span><span class="n">ds</span>

    <span class="c1">#2: pressure_force = b_div(v, p)</span>
    <span class="n">pressure_force</span> <span class="o">=</span> <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="n">div</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span> \
                     <span class="o">+</span> <span class="n">avg</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">jump</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">ne</span><span class="p">)</span><span class="o">*</span><span class="n">dS</span> \
                     <span class="o">+</span> <span class="n">p</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">ds</span>

    <span class="c1"># Optional stabilization terms, can be turned off by setting gamma_grad_div.value = 0, gamma_mass_flux.value = 0</span>
    <span class="c1"># TODO: do we need mu for the stabilization (which one)?</span>
    <span class="n">grad_div_stabilization</span> <span class="o">=</span> <span class="n">gamma_grad_div</span><span class="o">*</span><span class="n">div</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="n">div</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
    <span class="n">mass_flux_stabilization</span> <span class="o">=</span> <span class="n">gamma_mass_flux</span><span class="o">*</span><span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="n">h_int</span><span class="p">)</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">jump</span><span class="p">(</span><span class="n">u</span><span class="p">),</span><span class="n">ne</span><span class="p">)</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">jump</span><span class="p">(</span><span class="n">v</span><span class="p">),</span><span class="n">ne</span><span class="p">)</span><span class="o">*</span><span class="n">dS</span> \
                                              <span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">h_ext</span><span class="p">)</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">dirichlet_value_velocity</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">ds</span> <span class="p">)</span>
    <span class="n">pressure_stabilization</span> <span class="o">=</span> <span class="n">c_h_cburn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="n">stab_terms</span> <span class="o">=</span> <span class="n">grad_div_stabilization</span> <span class="o">+</span> <span class="n">mass_flux_stabilization</span> <span class="o">+</span> <span class="n">pressure_stabilization</span>

    <span class="n">continuity</span> <span class="o">=</span> <span class="o">-</span> <span class="n">q</span><span class="o">*</span><span class="n">div</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span> \
                 <span class="o">+</span> <span class="n">avg</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">jump</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">ne</span><span class="p">)</span><span class="o">*</span><span class="n">dS</span> \
                 <span class="o">+</span> <span class="n">q</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">dirichlet_value_velocity</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">ds</span>

    <span class="k">return</span> <span class="n">mu</span><span class="o">*</span><span class="n">viscous_stress</span> <span class="o">+</span> <span class="n">pressure_force</span> <span class="o">+</span> <span class="n">continuity</span> <span class="o">+</span> <span class="n">stab_terms</span> <span class="o">==</span> <span class="n">dot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
</pre></div>
</div>
</div>
<p>The DG weak form introduces a penalty for discontinuities in the discrete velocity. For a sufficiently large value of the penalty parameter <code class="docutils literal notranslate"><span class="pre">sigma_ip</span></code> penalization ensures coercivity of the bilinear form defined as <code class="docutils literal notranslate"><span class="pre">viscous_stress</span></code> above. However, increasing the penalty parameter has an adverse effect on the condition number of the linear system (<em>and the numerical convergence study below suggests it also degrades the pressure convergence rate?</em>) so one generally wants to find sigma_ip
“large enough but not too large”. The “optimal” <code class="docutils literal notranslate"><span class="pre">sigma_ip</span></code> would depend on the local mesh geometry and polynomial degree, here we generally just impose a global “guessed” value. Below we also offer two choices for <code class="docutils literal notranslate"><span class="pre">sigma_ip</span></code> from literature:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">penalty_parameter_abkas</span><span class="p">(</span><span class="n">order_discrete_space</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Penalty parameter for the interior penalty DG method</span>

<span class="sd">    Formula corresponds to to the heuristic parameter used in Sec. 6.1</span>
<span class="sd">    of https://doi.org/10.48550/arXiv.1711.04442,</span>
<span class="sd">    see definition of sigma on the very bottom of page 19.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">4</span><span class="o">*</span><span class="n">order_discrete_space</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">penalty_parameter_shabazi</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">order_discrete_space</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Penalty parameter for the interior penalty DG method</span>

<span class="sd">    Formula corresponds to Remark (4) of https://doi.org/10.1016/j.jcp.2004.11.017</span>
<span class="sd">    Carefully revise the assessment of faces if the code</span>
<span class="sd">    is ever changed to 3D! Also note that the derivation</span>
<span class="sd">    is for simplical meshes (not for quads!)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_ratio</span> <span class="o">=</span> <span class="mi">0</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; max. area / volume ratio of all elements on the grid &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">dimGrid</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; spatial dimension &quot;&quot;&quot;</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">order_discrete_space</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; approximation space order &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">view</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
        <span class="c1"># Iterate all elements and find the max. ratio of area / volume</span>
        <span class="c1"># (or edge length over area in 2D)</span>
        <span class="n">total_surface_area_element</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">subEntities</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">total_surface_area_element</span> <span class="o">+=</span> <span class="n">face</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">volume</span>

        <span class="n">ratio_element</span> <span class="o">=</span> <span class="n">total_surface_area_element</span> <span class="o">/</span> <span class="n">element</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">volume</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; the surface area / volume ratio of the current element &quot;&quot;&quot;</span>

        <span class="n">max_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">ratio_element</span><span class="p">,</span> <span class="n">max_ratio</span><span class="p">])</span>


    <span class="k">return</span> <span class="p">((</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="n">d</span><span class="p">)</span><span class="o">/</span><span class="n">d</span><span class="p">)</span><span class="o">*</span><span class="n">max_ratio</span>



<span class="c1">#########################</span>
</pre></div>
</div>
</div>
<section id="id3">
<h3>Bercovier-Engelmann Testcase<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<p>We repeat the test from above using using a composite DG space with Lagrangian polynomial basis:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------------&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Set up DG Scheme:&quot;</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dune.fem.space</span><span class="w"> </span><span class="kn">import</span> <span class="n">dglagrange</span><span class="p">,</span> <span class="n">composite</span>


<span class="n">velocity_order</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">space_velocity_dg</span> <span class="o">=</span> <span class="n">dglagrange</span><span class="p">(</span><span class="n">gridView</span><span class="p">,</span>
                            <span class="n">dimRange</span><span class="o">=</span><span class="n">dim_space</span><span class="p">,</span>
                            <span class="n">order</span><span class="o">=</span><span class="n">velocity_order</span><span class="p">,</span>
                            <span class="n">storage</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>

<span class="n">space_pressure_dg</span> <span class="o">=</span> <span class="n">dglagrange</span><span class="p">(</span><span class="n">gridView</span><span class="p">,</span>
                            <span class="n">dimRange</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">order</span><span class="o">=</span><span class="n">velocity_order</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">storage</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>


<span class="n">taylor_hood_space_dg</span> <span class="o">=</span> <span class="n">composite</span><span class="p">(</span><span class="n">space_velocity_dg</span><span class="p">,</span> <span class="n">space_pressure_dg</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;velocity&quot;</span><span class="p">,</span> <span class="s2">&quot;pressure&quot;</span><span class="p">])</span>

<span class="n">U</span>     <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="n">taylor_hood_space_dg</span><span class="p">)</span>
<span class="n">V</span>     <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="n">taylor_hood_space_dg</span><span class="p">)</span>

<span class="n">u_h</span> <span class="o">=</span> <span class="n">as_vector</span><span class="p">([</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">v_h</span> <span class="o">=</span> <span class="n">as_vector</span><span class="p">([</span><span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">p_h</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">q_h</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DG velocity element order: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">taylor_hood_space_dg</span><span class="o">.</span><span class="n">subSpaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">order</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DG pressure element order: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">taylor_hood_space_dg</span><span class="o">.</span><span class="n">subSpaces</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">order</span><span class="p">))</span>


<span class="n">is_dirichlet_velocity</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;all_boundaries&quot;</span><span class="p">)</span>
<span class="n">dirichlet_velocity</span> <span class="o">=</span> <span class="n">as_vector</span><span class="p">([</span><span class="n">u_exact</span><span class="p">,</span> <span class="n">v_exact</span><span class="p">])</span>
<span class="n">weak_form_stokes_dg</span> <span class="o">=</span> <span class="n">weak_form_stationary_stokes_dg</span><span class="p">(</span><span class="n">u_h</span><span class="p">,</span> <span class="n">v_h</span><span class="p">,</span> <span class="n">p_h</span><span class="p">,</span> <span class="n">q_h</span><span class="p">,</span> <span class="n">f_exact</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">is_dirichlet_velocity</span><span class="p">,</span> <span class="n">dirichlet_velocity</span><span class="p">)</span>
<span class="n">solution_vector_dg</span> <span class="o">=</span> <span class="n">taylor_hood_space_dg</span><span class="o">.</span><span class="n">interpolate</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;solution_vector_dg&quot;</span><span class="p">)</span>

<span class="n">solver_parameters</span> <span class="o">=</span><span class="p">{</span><span class="s2">&quot;nonlinear.tolerance&quot;</span><span class="p">:</span> <span class="mf">1e-10</span><span class="p">,</span>
                    <span class="s2">&quot;nonlinear.verbose&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;linear.tolerance&quot;</span><span class="p">:</span> <span class="mf">1e-14</span><span class="p">,</span>
                    <span class="s2">&quot;linear.preconditioning.method&quot;</span><span class="p">:</span> <span class="s2">&quot;ilu&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;linear.verbose&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;linear.maxiterations&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}</span>

<span class="n">scheme_taylor_hood_dg</span> <span class="o">=</span> <span class="n">solutionScheme</span><span class="p">(</span><span class="n">weak_form_stokes_dg</span><span class="p">,</span>
                                    <span class="n">space</span><span class="o">=</span><span class="n">taylor_hood_space_dg</span><span class="p">,</span>
                                    <span class="n">parameters</span><span class="o">=</span><span class="n">solver_parameters</span><span class="p">,</span>
                                    <span class="n">solver</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;istl&quot;</span><span class="p">,</span> <span class="s2">&quot;bicgstab&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


----------------------
Set up DG Scheme:
DG velocity element order: 3
DG pressure element order: 2
</pre></div></div>
</div>
<p>Test the DG setup on the toy mesh. By default all extra stabilization is turned off but you can play around with it by modifying the <code class="docutils literal notranslate"><span class="pre">Constant</span></code>’s values.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------------&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test solve with DG on the base mesh: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">method_switch_ip</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="c1"># Corresponds to SIPG (1: NIPG, 0: Diffusive Stabilization off)</span>

<span class="n">gamma_grad_div</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span>  <span class="mf">0.0</span>
<span class="n">gamma_mass_flux</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span>  <span class="mf">0.0</span>
<span class="n">gamma_stab_cburn</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="n">velocity_order</span> <span class="o">=</span> <span class="n">taylor_hood_space_dg</span><span class="o">.</span><span class="n">subSpaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">order</span>
<span class="n">sigma_ip</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">penalty_parameter_abkas</span><span class="p">(</span><span class="n">velocity_order</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Penalty parameter value: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sigma_ip</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
<span class="n">solution_vector_dg</span><span class="o">.</span><span class="n">interpolate</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">scheme_taylor_hood_dg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">solution_vector_dg</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number linear iterations: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;linear_iterations&#39;</span><span class="p">]))</span>
<br/><br/><br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


----------------------
Test solve with DG on the base mesh:

Penalty parameter value: 36.0
number linear iterations: 15
</pre></div></div>
</div>
</section>
</section>
<section id="Convergence-rate-check">
<h2>Convergence rate check<a class="headerlink" href="#Convergence-rate-check" title="Link to this heading"></a></h2>
<p>To validate our method we conduct a small experimental convergence study. The method <code class="docutils literal notranslate"><span class="pre">convergence_study</span></code> takes a scheme and executes a series of solves on a uniformly refined mesh. <em>Special care needs to be taken when choosing a fixed penalty parameter in the DG setting, since the necessary penalization scales with the characteristic mesh element size.</em></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ufl</span><span class="w"> </span><span class="kn">import</span> <span class="n">sqrt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dune.fem</span><span class="w"> </span><span class="kn">import</span> <span class="n">integrate</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>

<span class="k">def</span><span class="w"> </span><span class="nf">convergence_study</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">solution_vector</span><span class="p">,</span> <span class="n">refinement_steps</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">penalty</span> <span class="o">=</span> <span class="mi">20</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes a sequence of solves with the mesh uniformly refined `refinement_steps` times and</span>
<span class="sd">    computes the experimental order of convergence (EOC)</span>

<span class="sd">    :param scheme: solution scheme to check convergence for</span>
<span class="sd">    :param solution_vector: driscrete solution_vector</span>
<span class="sd">    :param refinement_steps: number of refinement steps, defaults to 3</span>
<span class="sd">    :type refinement_steps: int, optional</span>
<span class="sd">    :param penalty: penalty parameter for DG and the weak enforcement of boundary conditions, defaults to 20</span>
<span class="sd">                    note that the DG solver is very sensitive to this parameter and the optimal value</span>
<span class="sd">                    is a function of mesh size and polynomial degree. You can set the value to `None`</span>
<span class="sd">                    to try with a heuristic guess based on the velocity polynomial degree (see</span>
<span class="sd">                    `penalty_parameter_abkas()` method)</span>
<span class="sd">    :type penalty: int, optional</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">l2_errors</span> <span class="o">=</span>  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">h1_errors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">velocity_order</span> <span class="o">=</span> <span class="n">solution_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">order</span>
    <span class="n">pressure_order</span> <span class="o">=</span> <span class="n">velocity_order</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">avg_pressure</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;avg_pressure&quot;</span><span class="p">)</span> <span class="c1"># subtract average to get unique pressure</span>
    <span class="n">l2_error_pressure</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">solution_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">avg_pressure</span> <span class="o">-</span> <span class="n">p_exact</span><span class="p">,</span> <span class="n">solution_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">avg_pressure</span> <span class="o">-</span> <span class="n">p_exact</span><span class="p">)</span>
    <span class="n">h1_error_pressure</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">solution_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_exact</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">solution_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_exact</span><span class="p">))</span>

    <span class="n">numerical_velocity</span> <span class="o">=</span> <span class="n">as_vector</span><span class="p">([</span><span class="n">solution_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">solution_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">analytical_velocity</span> <span class="o">=</span> <span class="n">as_vector</span><span class="p">([</span><span class="n">u_exact</span><span class="p">,</span> <span class="n">v_exact</span><span class="p">])</span>

    <span class="n">l2_error_velocity</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">numerical_velocity</span> <span class="o">-</span> <span class="n">analytical_velocity</span><span class="p">,</span> <span class="n">numerical_velocity</span> <span class="o">-</span> <span class="n">analytical_velocity</span><span class="p">)</span>
    <span class="n">h1_error_velocity</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">numerical_velocity</span> <span class="o">-</span> <span class="n">analytical_velocity</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">numerical_velocity</span> <span class="o">-</span> <span class="n">analytical_velocity</span><span class="p">))</span>

    <span class="c1"># Make sure that the mesh is the coarsest refinement level</span>
    <span class="c1"># to begin with</span>
    <span class="n">gridView</span><span class="o">.</span><span class="n">hierarchicalGrid</span><span class="o">.</span><span class="n">globalRefine</span><span class="p">(</span><span class="o">-</span><span class="n">gridView</span><span class="o">.</span><span class="n">hierarchicalGrid</span><span class="o">.</span><span class="n">maxLevel</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">eocLoop</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">refinement_steps</span><span class="p">):</span>

        <span class="n">element_size</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">gridView</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">penalty</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">sigma_ip</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">penalty_parameter_abkas</span><span class="p">(</span><span class="n">velocity_order</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Penalty parameter value: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sigma_ip</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sigma_ip</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">penalty</span>

        <span class="n">solution_vector</span><span class="o">.</span><span class="n">interpolate</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">solution_vector</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> linear iteratrion: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;linear_iterations&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">avg_pressure</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">solution_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">integrate</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> average pressure: </span><span class="si">{</span><span class="n">avg_pressure</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">l2_errors_old</span> <span class="o">=</span> <span class="n">l2_errors</span>
        <span class="n">h1_errors_old</span> <span class="o">=</span> <span class="n">h1_errors</span>

        <span class="n">l2_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">sqrt</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">integrate</span><span class="p">([</span><span class="n">l2_error_pressure</span><span class="p">,</span><span class="n">l2_error_velocity</span><span class="p">])]</span> <span class="p">)</span>
        <span class="n">h1_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">sqrt</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">integrate</span><span class="p">([</span><span class="n">h1_error_pressure</span><span class="p">,</span><span class="n">h1_error_velocity</span><span class="p">])]</span> <span class="p">)</span>
        <span class="c1"># h1_errors += l2_errors</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">solution_vector</span> <span class="o">-</span> <span class="n">as_vector</span><span class="p">(</span> <span class="p">[</span><span class="n">u_exact</span><span class="p">,</span> <span class="n">v_exact</span><span class="p">,</span> <span class="n">p_exact</span><span class="o">+</span><span class="n">avg_pressure</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">eocLoop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">eocs_l2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">]</span>
            <span class="n">eocs_h1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eocs_l2</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">round</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">e</span><span class="o">/</span><span class="n">e_old</span><span class="p">)</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span> \
                    <span class="k">for</span> <span class="n">e</span><span class="p">,</span><span class="n">e_old</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l2_errors</span><span class="p">,</span><span class="n">l2_errors_old</span><span class="p">)</span> <span class="p">]</span>
            <span class="n">eocs_h1</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">round</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">e</span><span class="o">/</span><span class="n">e_old</span><span class="p">)</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span> \
                    <span class="k">for</span> <span class="n">e</span><span class="p">,</span><span class="n">e_old</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">h1_errors</span><span class="p">,</span><span class="n">h1_errors_old</span><span class="p">)</span> <span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Step:&#39;</span><span class="p">,</span> <span class="n">eocLoop</span><span class="p">,</span> <span class="s1">&#39;, size:&#39;</span><span class="p">,</span> <span class="n">gridView</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> | p_h - p | =&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:0.5e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l2_errors</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s1">&#39;, eoc =&#39;</span><span class="p">,</span> <span class="n">eocs_l2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> | u_h - u | =&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:0.5e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l2_errors</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s1">&#39;, eoc =&#39;</span><span class="p">,</span> <span class="n">eocs_l2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> | grad(p_h - p) | =&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:0.5e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h1_errors</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s1">&#39;, eoc =&#39;</span><span class="p">,</span> <span class="n">eocs_h1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> | grad(u_h - u) | =&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:0.5e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h1_errors</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s1">&#39;, eoc =&#39;</span><span class="p">,</span> <span class="n">eocs_h1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">eocLoop</span> <span class="o">&lt;</span> <span class="n">refinement_steps</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">gridView</span><span class="o">.</span><span class="n">hierarchicalGrid</span><span class="o">.</span><span class="n">globalRefine</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Convergence Test Continuous Galerkin:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------------&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test convergence with CG: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Velocity polynomial order: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">taylor_hood_space</span><span class="o">.</span><span class="n">subSpaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">order</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pressure polynomial order: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">taylor_hood_space</span><span class="o">.</span><span class="n">subSpaces</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">order</span><span class="p">))</span>

<span class="n">convergence_study</span><span class="p">(</span><span class="n">scheme</span><span class="o">=</span><span class="n">scheme_taylor_hood_cg</span><span class="p">,</span>
                  <span class="n">solution_vector</span><span class="o">=</span><span class="n">solution_vector_cg</span><span class="p">,</span>
                  <span class="n">refinement_steps</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                  <span class="n">penalty</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


----------------------
Test convergence with CG:

Velocity polynomial order: 3
Pressure polynomial order: 2
         linear iteratrion: 13
         average pressure: 0.09403072439563814
Step: 0 , size: 49
         | p_h - p | = 2.58255e-05 , eoc = -
         | u_h - u | = 8.23162e-05 , eoc = -
         | grad(p_h - p) | = 1.04979e-03 , eoc = -
         | grad(u_h - u) | = 5.53186e-03 , eoc = -


         linear iteratrion: 27
         average pressure: 0.02513838428515213
Step: 1 , size: 196
         | p_h - p | = 5.91246e-07 , eoc = 5.45
         | u_h - u | = 5.17131e-06 , eoc = 3.99
         | grad(p_h - p) | = 4.70596e-05 , eoc = 4.48
         | grad(u_h - u) | = 6.89060e-04 , eoc = 3.01


</pre></div></div>
</div>
<p>Convergence Test DG: <em>You can increase the number of refinement steps but expect a longer wait for serial runs</em></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------------&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test convergence with DG: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Velocity polynomial order: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">taylor_hood_space_dg</span><span class="o">.</span><span class="n">subSpaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">order</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pressure polynomial order: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">taylor_hood_space_dg</span><span class="o">.</span><span class="n">subSpaces</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">order</span><span class="p">))</span>

<span class="n">method_switch_ip</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
<span class="n">gamma_grad_div</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">gamma_mass_flux</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">gamma_stab_cburn</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="c1"># Careful with penalty, sigma = 20 works for P3/P2 elements</span>
<span class="n">convergence_study</span><span class="p">(</span><span class="n">scheme</span><span class="o">=</span><span class="n">scheme_taylor_hood_dg</span><span class="p">,</span>
                  <span class="n">solution_vector</span><span class="o">=</span><span class="n">solution_vector_dg</span><span class="p">,</span>
                  <span class="n">refinement_steps</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                  <span class="n">penalty</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


----------------------
Test convergence with DG:

Velocity polynomial order: 3
Pressure polynomial order: 2
         linear iteratrion: 14
         average pressure: -0.08740945315166056
Step: 0 , size: 49
         | p_h - p | = 5.35523e-05 , eoc = -
         | u_h - u | = 7.83280e-05 , eoc = -
         | grad(p_h - p) | = 1.42791e-03 , eoc = -
         | grad(u_h - u) | = 5.94741e-03 , eoc = -


         linear iteratrion: 31
         average pressure: -0.018921442116436663
Step: 1 , size: 196
         | p_h - p | = 1.80719e-06 , eoc = 4.89
         | u_h - u | = 5.04081e-06 , eoc = 3.96
         | grad(p_h - p) | = 9.15202e-05 , eoc = 3.96
         | grad(u_h - u) | = 7.15726e-04 , eoc = 3.05


</pre></div></div>
</div>
<p>As a sanity check for the construction of the composite DG spaces we can count the degrees of freedom of the <code class="docutils literal notranslate"><span class="pre">solution_vector</span></code>. Each quad has <span class="math notranslate nohighlight">\((k + 1)^2\)</span> degrees of freedom per dimension, with <span class="math notranslate nohighlight">\(k=\)</span> polynomial order of the approximation function.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">dof_count_taylor_hood_quad_mesh</span><span class="p">(</span><span class="n">velocity_order</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">pressure_order</span> <span class="o">=</span> <span class="n">velocity_order</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">number_elements</span> <span class="o">=</span> <span class="n">gridView</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">dim_space</span> <span class="o">=</span> <span class="n">gridView</span><span class="o">.</span><span class="n">dimension</span>
    <span class="n">number_velocity_dofs_lagrange_polynomial_per_quad</span> <span class="o">=</span> <span class="p">(</span><span class="n">velocity_order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">dim_space</span>
    <span class="n">number_pressure_dofs_lagrange_polynomial_per_quad</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressure_order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="c1"># Because for DG all DOFs are independent we can just count</span>
    <span class="c1"># number quads * number dofs per quad</span>
    <span class="c1"># where</span>
    <span class="c1"># number dofs per quad = velocity_dofs + pressure_dofs</span>
    <span class="k">return</span> <span class="n">number_elements</span><span class="o">*</span><span class="p">(</span><span class="n">number_velocity_dofs_lagrange_polynomial_per_quad</span> <span class="o">+</span> <span class="n">number_pressure_dofs_lagrange_polynomial_per_quad</span><span class="p">)</span>

<span class="n">velocity_order</span> <span class="o">=</span> <span class="n">taylor_hood_space_dg</span><span class="o">.</span><span class="n">subSpaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">order</span>
<span class="n">pressure_order</span> <span class="o">=</span> <span class="n">velocity_order</span> <span class="o">-</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------------&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Count DOFs:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expected dofs for taylor P&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">velocity_order</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; / P&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pressure_order</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; TH elements: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dof_count_taylor_hood_quad_mesh</span><span class="p">(</span><span class="n">velocity_order</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DOFS composite solution vector: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">solution_vector_dg</span><span class="o">.</span><span class="n">as_numpy</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


----------------------
Count DOFs:
Expected dofs for taylor P3 / P2 TH elements: 8036
DOFS composite solution vector: 8036
</pre></div></div>
</div>
</section>
</section>
<div class="admonition note">
<p class="admonition-title">Note</p>
This document is part of the dune-fem tutorial
<a href="https://doi.org/10.5281/zenodo.3706994"><img src="https://zenodo.org/badge/DOI/10.5281/zenodo.3706994.svg" alt="DOI"></a><div class="line-block">
<div class="line">Download <em>monolithicStokes</em> as <a class="reference download internal" download="" href="_downloads/c3bda2dfe0906564f00af8060fbec660/monolithicStokes_nb.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Jupyter</span> <span class="pre">notebook</span> <span class="pre">(.ipynb)</span></code></a> or as <a class="reference download internal" download="" href="_downloads/3c3f7a2fa3a6b47c7f401c2620f37eb1/monolithicStokes.py"><code class="xref download docutils literal notranslate"><span class="pre">Python</span> <span class="pre">script</span> <span class="pre">(.py)</span></code></a></div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="stokes.html" class="btn btn-neutral float-left" title="Saddle point solver for the stationary Stokes problem" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="fieldsplitStokes_nb.html" class="btn btn-neutral float-right" title="Stokes problem with fieldsplit preconditioner (PETSc)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2025, Andreas Dedner and Robert Klöfkorn.
      <span class="lastupdated">Last updated on Dec 01, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script> 

</body>
</html>